import google.generativeai as genai
import asyncio
from typing import Dict, Any, List, Optional
from dotenv import load_dotenv
import os
from ..utils.json_parser import extract_json_from_text

class GeminiClient:
    def __init__(self, api_key: str = None):
        load_dotenv()
        self.api_key = api_key or os.getenv('GEMINI_API_KEY') or os.getenv('GOOGLE_API_KEY')
        if not self.api_key:
            raise ValueError("è«‹è¨­å®š GEMINI_API_KEY æˆ– GOOGLE_API_KEY ç’°å¢ƒè®Šæ•¸")
        
        genai.configure(api_key=self.api_key)
        
        # è¨­ç½®ä¸»è¦æ¨¡å‹ (gemini-2.5-flash)
        self.primary_model_name = os.getenv('GEMINI_MODEL_NAME', 'gemini-2.5-flash')
        self.model = genai.GenerativeModel(self.primary_model_name)
        
        # è¨­ç½®è¼”åŠ©æ¨¡å‹ (gemini-1.5-flash) ç”¨æ–¼ç°¡å–®ä»»å‹™
        self.secondary_model_name = 'gemini-1.5-flash'
        self.secondary_model = genai.GenerativeModel(self.secondary_model_name)
        
        self.generation_config = genai.types.GenerationConfig(
            temperature=0.2,
            top_p=0.9,
            max_output_tokens=8192,
            response_mime_type="application/json"
        )
        
        # ç”¨æ–¼å¿ƒæ™ºåœ–ç”Ÿæˆçš„ç‰¹æ®Šé…ç½®
        self.mindmap_config = genai.types.GenerationConfig(
            temperature=0.3,
            top_p=0.9,
            max_output_tokens=4096,
            response_mime_type="text/plain"
        )
    
    async def _generate_with_json_parsing(self, prompt: str) -> Optional[Dict[str, Any]]:
        raw_response = await self.generate_async(prompt)
        if not raw_response:
            return None
        
        parsed_json = extract_json_from_text(raw_response)
        return parsed_json

    async def generate_async(self, prompt: str, is_json: bool = True) -> str:
        try:
            config = self.generation_config if is_json else genai.types.GenerationConfig(
                temperature=0.3,
                top_p=0.9,
                max_output_tokens=4096
            )
            response = await asyncio.to_thread(
                self.model.generate_content,
                prompt,
                generation_config=config
            )
            return response.text
        except Exception as e:
            print(f"Gemini API éŒ¯èª¤: {e}")
            return ""

    async def parse_exam_paper(self, text: str) -> Dict[str, Any]:
        """
        è§£æè€ƒå·å…§å®¹ï¼Œè‡ªå‹•åˆ†å‰²é¡Œç›®ä¸¦è­˜åˆ¥è€ƒç§‘ï¼Œä¸¦é€²è¡Œé›£åº¦åˆ†ç´š
        ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ (gemini-1.5-flash) é€²è¡Œå…§å®¹åˆ†é¡
        """
        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆç²¾æ–¼è§£æå°ç£åœ‹å®¶è€ƒè©¦é¡Œåº«çš„ AI åˆ†æå¸«ã€‚ä½ çš„æ ¸å¿ƒä»»å‹™æ˜¯å°‡è¼¸å…¥çš„æ–‡æœ¬ï¼Œç²¾æº–åœ°è½‰æ›ç‚ºçµæ§‹åŒ–çš„ JSON æ ¼å¼ï¼Œä¸¦ç¢ºä¿æœ€çµ‚è¼¸å‡ºçš„å¯è®€æ€§ã€‚è«‹åš´æ ¼éµå¾ªä»¥ä¸‹æ‰€æœ‰æº–å‰‡é€²è¡Œåˆ†æã€‚

        ### I. æ ¸å¿ƒä»»å‹™æ¦‚è¦½
        1.  **å…§å®¹å®šæ€§**ï¼šåˆ¤æ–·æ–‡æœ¬é¡å‹ï¼ˆè€ƒå·æˆ–å­¸ç¿’è³‡æ–™ï¼‰èˆ‡å°ˆæ¥­è€ƒç§‘ã€‚
        2.  **é¡Œç›®æ•´åˆ**ï¼šè‹¥ç‚ºè€ƒå·ï¼Œä¾æ“šã€Œé»ƒé‡‘æº–å‰‡ã€å°‡é—œè¯åœ¨ä¸€èµ·çš„é¡Œçµ„æ•´åˆç‚ºå–®ä¸€é¡Œç›®ç‰©ä»¶ï¼Œä½†åˆ‡è¨˜ç„¡å°‡ä¸åŒé¡Œçµ„æ··æ·†ï¼Œæ¯”æ–¹èªª:
        -   **æ‰¿ä¸Šé¡Œã€æ¥ä¸Šé¡Œã€å»¶çºŒä¸Šé¡Œã€æ ¹æ“šä¸Šé¡Œã€åŸºæ–¼å‰é¡Œç­‰**ï¼šé€™äº›é—œéµå­—è¡¨ç¤ºç•¶å‰é¡Œç›®èˆ‡å‰ä¸€é¡Œæœ‰é—œè¯ï¼Œæ‡‰å°‡å®ƒå€‘åˆä½µç‚ºä¸€å€‹é …ç›®ã€‚
        -   **ç„¡é—œè¯çš„é¡Œç›®**ï¼šå¦‚æœé¡Œç›®èˆ‡é¡Œç›®ä¹‹é–“æåˆ°ç›¸åŒé—œéµå­—ï¼Œæ¯”æ–¹èªªè™›æ“¬ç¢¼ã€è³‡è¨Šå®‰å…¨ç­‰ï¼Œä½†æ˜¯æ²’æœ‰ä¸Šé¢çš„é—œéµå­—ï¼Œå‹¿å°‡ä»–å€‘è¦–ç‚ºåŒä¸€é¡Œï¼Œå› ç‚ºä»–å€‘å¯èƒ½æ˜¯åœ¨åŒä¸€å€‹ç§‘ç›®çš„è€ƒå·ä¸Šã€‚
        3.  **å­¸ç¿’è³‡æ–™æå–**ï¼šè‹¥ç‚ºå­¸ç¿’è³‡æ–™ï¼Œå‰‡æå–å…¶æ‘˜è¦èˆ‡æ ¸å¿ƒçŸ¥è­˜é»ã€‚
        4.  **æ™ºèƒ½æ ¼å¼åŒ–**ï¼šè™•ç†ç¨‹å¼ç¢¼ã€ç†è§£èªæ„æ ¼å¼ï¼Œä¸¦å„ªåŒ–æ’ç‰ˆã€‚
        5.  **é›£åº¦åˆ†æ**ï¼šç‚ºæ¯å€‹è€ƒé¡Œé€²è¡Œé›£åº¦åˆ†ç´šã€‚


        ---

        ### II. é¡Œç›®åˆ†å‰²é»ƒé‡‘æº–å‰‡ï¼š
        **é€™æ˜¯æœ€é‡è¦çš„æº–å‰‡ã€‚ä½ çš„ç›®æ¨™æ˜¯ç¢ºä¿æ¯ä¸€å€‹è¼¸å‡ºçš„ `stem` éƒ½æ˜¯ä¸€å€‹ã€Œå¯ä»¥ç¨ç«‹ä½œç­”ã€çš„å®Œæ•´å•é¡Œã€‚**

        *   **æ ¸å¿ƒæ¦‚å¿µï¼šé¡Œç›®ä¸»è¦é¡Œå¹¹ (Shared Context)**
            *   ä¸€ä»½è€ƒå·çš„å¤§é¡Œï¼Œé€šå¸¸åŒ…å«å…©éƒ¨åˆ†ï¼š
                1.  **é¡Œç›®ä¸»è¦é¡Œå¹¹**ï¼šåœ¨é ‚å±¤é¡Œè™Ÿï¼ˆå¦‚ã€Œä¸€ã€ã€ï¼‰ä¹‹å¾Œã€ç¬¬ä¸€å€‹å­å•é¡Œï¼ˆå¦‚ã€Œ(ä¸€)ã€ï¼‰ä¹‹å‰çš„æ‰€æœ‰å‰å°æè¿°ã€‚
                2.  **å­å•é¡Œåˆ—è¡¨**ï¼šä»¥ `(ä¸€)`ã€`(äºŒ)` æˆ– `(1)`ã€`(2)` æ¨™ç¤ºçš„å¤šå€‹å…·é«”å•é¡Œã€‚

        *   **åˆ†å‰²èˆ‡é‡çµ„çš„åŸ·è¡Œæ¼”ç®—æ³•**ï¼š
            1.  **è­˜åˆ¥å¤§é¡Œ**ï¼šæ‰¾åˆ°ã€Œä¸€ã€ã€ã€ã€ŒäºŒã€ã€ç­‰é ‚å±¤é¡Œè™Ÿã€‚
            2.  **å®Œæ•´æå–I**ï¼šå°‡å¾ä¸€å€‹é ‚å±¤é¡Œè™Ÿé–‹å§‹ï¼Œç›´åˆ°ä¸‹ä¸€å€‹é ‚å±¤é¡Œè™Ÿå‡ºç¾ä¹‹å‰ï¼ˆæˆ–æ–‡ä»¶çµæŸï¼‰çš„æ‰€æœ‰å…§å®¹ï¼Œè¦–ç‚º**ä¸€å€‹å®Œæ•´çš„å¤§é¡Œ**ã€‚
            3.  **å®Œæ•´æå–II**ï¼šå¦‚æœå‡ºç¾æ‰¿ä¸Šé¡Œã€æ¥ä¸Šé¡Œã€å»¶çºŒä¸Šé¡Œã€æ ¹æ“šä¸Šé¡Œã€åŸºæ–¼å‰é¡Œç­‰ï¼Œç„¡è¦–é ‚å±¤é¡Œè™Ÿï¼Œå°‡å…©å€‹å¤§é¡Œç›®è¦–ç‚ºåŒä¸€é¡Œï¼Œå¦‚æœæ²’æœ‰å‡ºç¾æ‰¿ä¸Šé¡Œã€æ¥ä¸Šé¡Œã€å»¶çºŒä¸Šé¡Œã€æ ¹æ“šä¸Šé¡Œã€åŸºæ–¼å‰é¡Œç­‰é—œéµå­—ï¼Œ**è«‹å‹¿å°‡ä»–å€‘è¦–ç‚ºåŒä¸€é¡Œ**ã€‚
        
        **ç›®æ¨™**ï¼šå°‡ä¸€å€‹é‚è¼¯ä¸Šå®Œæ•´çš„å¤§é¡Œï¼ˆåŒ…å«æ‰€æœ‰å­å•é¡Œï¼‰æ”¾åœ¨ä¸€å€‹ `stem` å…§ã€‚    
        
        ---

        ### III. å…¶ä»–åˆ†ææº–å‰‡

        *   **æº–å‰‡ Aï¼šå…§å®¹é¡å‹èˆ‡è€ƒç§‘åˆ¤æ–·**
            *   **å…§å®¹é¡å‹åˆ¤æ–·**ï¼š
                *   **åˆ¤æ–·ç‚ºã€Œè€ƒå· (exam_paper)ã€çš„è¨Šè™Ÿ**ï¼šå‡ºç¾æ˜ç¢ºé¡Œè™Ÿã€é…åˆ†ã€è€ƒè©¦æ™‚é–“ã€åº§è™Ÿç­‰ã€‚
                *   **åˆ¤æ–·ç‚ºã€Œå­¸ç¿’è³‡æ–™ (study_material)ã€çš„è¨Šè™Ÿ**ï¼šå‡ºç¾ç« ç¯€æ¨™é¡Œã€å¤§æ®µé€£çºŒçš„èªªæ˜æ€§æ–‡å­—ã€‚
            *   **è€ƒç§‘è­˜åˆ¥ (åš´æ ¼é™åˆ¶)**ï¼š
                1.  **åˆ†æ**ï¼šé¦–å…ˆï¼Œæ ¹æ“šæ–‡æœ¬ä¸­çš„é—œéµè¡“èªé€²è¡Œåˆ†æã€‚
                2.  **é¸æ“‡**ï¼šç„¶å¾Œï¼Œ**å‹™å¿…**å¾ä»¥ä¸‹**å›ºå®šåˆ—è¡¨**ä¸­é¸æ“‡æœ€ç¬¦åˆçš„ä¸€å€‹è€ƒç§‘å¡«å…¥ `subject` æ¬„ä½ã€‚
                    *   `è³‡æ–™çµæ§‹` - é€šå¸¸æ˜¯æ¼”ç®—æ³•ã€è³‡æ–™çµæ§‹ç›¸é—œçš„é¡Œç›®ã€‚
                    *   `è³‡è¨Šç®¡ç†` - é€šå¸¸æ˜¯è³‡è¨Šç³»çµ±ã€ç®¡ç†ç›¸é—œçš„é¡Œç›®ã€‚
                    *   `è³‡é€šç¶²è·¯èˆ‡è³‡è¨Šå®‰å…¨` - é€šå¸¸æ˜¯ç¶²è·¯å®‰å…¨ã€è³‡å®‰ç›¸é—œçš„é¡Œç›®ï¼Œå¦‚æœé¡Œç›®æœ‰æåˆ°å€‹è³‡æ³•æ¢æˆ–æ˜¯è³‡å®‰ç›¸é—œè­°é¡Œï¼Œä¹Ÿè«‹æ”¾å…¥é€™è£¡ã€‚
                    *   `è³‡æ–™åº«æ‡‰ç”¨` - é€šå¸¸æ˜¯å¯¦é«”é—œè¯åœ–ã€è³‡æ–™åº«è¨­è¨ˆã€SQL æŸ¥è©¢ç›¸é—œçš„é¡Œç›®ã€‚
                3.  **å¾Œå‚™é¸é …**ï¼šå¦‚æœå…§å®¹æ˜é¡¯ä¸å±¬æ–¼ä»¥ä¸Šä»»ä½•ä¸€é …ï¼Œè«‹çµ±ä¸€ä½¿ç”¨ `è³‡è¨Šç®¡ç†`ã€‚**ç¦æ­¢**å‰µé€ åˆ—è¡¨ä¸­ä¸å­˜åœ¨çš„è€ƒç§‘åç¨±ã€‚

        *   **æº–å‰‡ Bï¼šé¡Œç›®é›£åº¦åˆ†ç´šæ¨™æº–**
            *   è«‹æ ¹æ“šä»¥ä¸‹æ¨™æº–ï¼Œç‚º**æ¯ä¸€å€‹**æœ€çµ‚çµ„åˆå¥½çš„ `stem` è©•å®šé›£åº¦ã€‚
            *   **ğŸŸ¢ ç°¡å–®é¡Œç›®ï¼ˆé«˜å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šæ˜ç¢ºæŒ‡å®šåˆ†ææ¡†æ¶æˆ–æ–¹æ³•ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹èªªæ˜...ã€ã€ã€Œè«‹è§£é‡‹...ã€ã€ã€Œä¾æ“š...æ¡†æ¶ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šå®šç¾©å‹ã€èªªæ˜å‹ã€‚
            *   **ğŸŸ¡ ä¸­ç­‰é¡Œç›®ï¼ˆä¸­å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šæä¾›éƒ¨åˆ†å¼•å°ï¼Œä½†ä¸æŒ‡å®šå…·é«”åˆ†ææ¡†æ¶ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹åˆ†æ...ã€ã€ã€Œè«‹æ¯”è¼ƒ...ã€ã€ã€Œè«‹è©•ä¼°...ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šåˆ†æå‹ã€æ¯”è¼ƒå‹ã€‚
            *   **ğŸ”´ å›°é›£é¡Œç›®ï¼ˆä½å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šé–‹æ”¾æ€§å•é¡Œï¼Œéœ€è¦ç¶œåˆå¤šç¨®çŸ¥è­˜ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹è¨­è¨ˆ...ã€ã€ã€Œåˆ¶å®šç­–ç•¥...ã€ã€ã€Œæå‡ºè§£æ±ºæ–¹æ¡ˆ...ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šè¨­è¨ˆå‹ã€ç­–ç•¥å‹ã€ç¶œåˆæ‡‰ç”¨å‹ã€‚

        *   **æº–å‰‡ Cï¼šæ ¼å¼åŒ–è¦å‰‡**
            *   **ç¨‹å¼ç¢¼æ ¼å¼åŒ–**ï¼šä¿¡ä»»è¼¸å…¥çš„ç¸®æ’ï¼Œåªéœ€ç”¨ ```pseudocode ... ``` åŒ…è£¹ç¨‹å¼ç¢¼å€å¡Šã€‚**çµ•å°ä¸è¦**ä¿®æ”¹ç¸®æ’ã€‚
            *   **èªæ„æ ¼å¼åŒ– (è™•ç†åº•ç·šç­‰)**ï¼š
                1.  **æƒæé—œéµå¥**ï¼šåœ¨æ–‡æœ¬ä¸­å°‹æ‰¾æè¿°æ ¼å¼æ„ç¾©çš„å¥å­ï¼Œä¾‹å¦‚ã€Œ**åŠ åº•ç·šçš„å±¬æ€§ç‚ºè©²è¡¨æ ¼ä¹‹ä¸»éµ**ã€ã€‚
                2.  **ç†è§£è¦å‰‡**ï¼šç†è§£é€™å¥è©±çš„å«ç¾©ï¼ˆåº•ç·š = ä¸»éµï¼‰ã€‚
                3.  **æ‡‰ç”¨è¦å‰‡**ï¼šåœ¨æœ€çµ‚è¼¸å‡ºçš„ `stem` ä¸­ï¼Œå°‡é€™å€‹èªæ„è³‡è¨Šä»¥æ–‡å­—å½¢å¼**æ˜ç¢ºæ¨™è¨»**å‡ºä¾†ã€‚ä¾‹å¦‚ï¼Œå°‡ `å“¡å·¥ (å“¡å·¥ç·¨è™Ÿ)` è½‰æ›ç‚º `å“¡å·¥ (å“¡å·¥ç·¨è™Ÿ (ä¸»éµ))`ã€‚
            *   **èªæ„é‡æ’ç‰ˆ (Readability Reformatting - æ–°å¢)**ï¼š
                1.  **æª¢æŸ¥çµæ§‹**ï¼šåœ¨çµ„åˆå®Œ `stem` å¾Œï¼Œæª¢æŸ¥å…¶æ’ç‰ˆã€‚
                2.  **è­˜åˆ¥é‚è¼¯å€å¡Š**ï¼šæ‰¾å‡ºæ–‡æœ¬ä¸­çš„ã€Œå‰å°èªªæ˜ã€ã€ã€Œè¡¨æ ¼ç¶±è¦ã€ã€ã€Œå­å•é¡Œåˆ—è¡¨ã€ç­‰é‚è¼¯å€å¡Šã€‚
                3.  **å„ªåŒ–æ’ç‰ˆ**ï¼šå¦‚æœé€™äº›å€å¡Šéƒ½æ“ åœ¨åŒä¸€å€‹æ®µè½ï¼Œè«‹ä½¿ç”¨æ›è¡Œå’Œ Markdown åˆ—è¡¨ï¼ˆä¾‹å¦‚ï¼Œå°‡ `(ä¸€)...(äºŒ)...` è½‰æ›æˆä¸€å€‹æ¸…æ™°çš„é»åˆ—æˆ–ç·¨è™Ÿåˆ—è¡¨ï¼‰ä¾†é‡æ–°çµ„ç¹” `stem` çš„å…§å®¹ï¼Œä½¿å…¶çµæ§‹æ¸…æ™°ã€æ˜“æ–¼é–±è®€ï¼Œä»¥ä¸‹æ˜¯ç¯„ä¾‹:
                ```å°ç£æ˜¯ä¸€å€‹å¤šå±±åœ‹å®¶ï¼Œä¾æ“šé€™æ ¼æ¢ä»¶å›ç­”ä¸‹åˆ—å•é¡Œ:(ä¸€) å°ç£çš„åœ°ç†ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ(äºŒ) å°ç£çš„æ°£å€™ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ(ä¸‰) å°ç£çš„æ–‡åŒ–ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ```
                æ‡‰è®Šæˆ:
                ```
                å°ç£æ˜¯ä¸€å€‹å¤šå±±åœ‹å®¶ï¼Œä¾æ“šé€™æ ¼æ¢ä»¶å›ç­”ä¸‹åˆ—å•é¡Œ:
                (ä¸€) å°ç£çš„åœ°ç†ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ
                (äºŒ) å°ç£çš„æ°£å€™ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ
                (ä¸‰) å°ç£çš„æ–‡åŒ–ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ
                ```
                ä¸ç®¡æ˜¯æ®µè½æ›è¡Œé‚„æ˜¯å­é¡Œç›®æ›è¡Œï¼Œæ›è¡Œè«‹å¿…é ˆä¸€å®šè¦ä½¿ç”¨å…©å€‹é€£çºŒçš„æ›è¡Œç¬¦ï¼ˆ\n\nï¼‰ä¾†åˆ†éš”
        ---

        ### IV. è¼¸å…¥æ–‡æœ¬
        ```
        {text}
        ```

        ### V. è¼¸å‡ºæ ¼å¼ (JSON)

        **è™•ç†æ­¥é©Ÿï¼š**
        1. é¦–å…ˆè­˜åˆ¥è³‡æ–™çš„å±¬æ€§ç‚ºä½• - æº–å‰‡ A
        2. æª¢æŸ¥æ¯å€‹é¡Œç›®æ˜¯å¦åŒ…å«é—œè¯æ€§é—œéµå­—ï¼ˆæ‰¿ä¸Šé¡Œã€æ¥ä¸Šé¡Œã€å»¶çºŒä¸Šé¡Œã€æ ¹æ“šä¸Šé¡Œã€åŸºæ–¼å‰é¡Œç­‰ï¼‰- é¡Œç›®åˆ†å‰²é»ƒé‡‘æº–å‰‡
        3. å¦‚æœç™¼ç¾é—œè¯æ€§é—œéµå­—ï¼Œå°‡è©²é¡Œèˆ‡å‰ä¸€é¡Œåˆä½µç‚ºä¸€å€‹é …ç›® - é¡Œç›®åˆ†å‰²é»ƒé‡‘æº–å‰‡
        4. å¦‚æœæ˜¯å…±äº«ä¸Šä¸‹æ–‡çš„å¤§é¡Œï¼Œå°‡å…¶èˆ‡æ‰€æœ‰å­å•é¡Œçµ„åˆæˆä¸€å€‹å®Œæ•´çš„é¡Œç›®é …ç›® - é¡Œç›®åˆ†å‰²é»ƒé‡‘æº–å‰‡
        5. å°æ¯å€‹æœ€çµ‚çš„é¡Œç›®é …ç›®é€²è¡Œé›£åº¦åˆ†ç´š - æº–å‰‡ B
        6. å°‡é¡Œç›®æ ¼å¼åŒ–ç”¢ç”Ÿä¸€å®šçš„å¯è®€æ€§ - æº–å‰‡ C
        7. åˆ†æé¡Œç›®æˆ–å­¸ç¿’è³‡æ–™çš„ç›¸é—œçŸ¥è­˜é»ã€‚
        8. æœ€å¾Œï¼Œå°‡æ‰€æœ‰é …ç›®çµ„åˆæˆä¸€å€‹å®Œæ•´çš„ JSON çµæ§‹

        
        ä½ çš„è¼¸å‡ºçµæ§‹å¿…é ˆæ ¹æ“šä½ åœ¨ã€æº–å‰‡Aã€‘ä¸­åˆ¤æ–·çš„ content_type ä¾†å‹•æ…‹æ”¹è®Šï¼Œè«‹åš´æ ¼éµå®ˆï¼
        **æƒ…æ³ä¸€ï¼šå¦‚æœ content_type æ˜¯ exam_paper**

        {{
            "content_type": "exam_paper",
            "subject": "å¾ã€æº–å‰‡Aã€‘çš„å›ºå®šåˆ—è¡¨ä¸­é¸æ“‡çš„è€ƒç§‘åç¨±",
            "questions": [
                {{
                    "title": "æ•´å€‹å¤§é¡Œçš„ç°¡çŸ­æ¨™é¡Œ",
                    "stem": "ä¸€å€‹å¤§é¡Œçš„å…¨éƒ¨å…§å®¹ï¼Œä¸¦ç¶“éã€æº–å‰‡Cã€‘çš„æ’ç‰ˆå„ªåŒ–èˆ‡èªæ„æ¨™è¨»ã€‚",
                    "knowledge_points": ["ç›¸é—œçŸ¥è­˜é»1", "ç›¸é—œçŸ¥è­˜é»2"],
                    "difficulty": "å°æ•´å€‹å¤§é¡Œçš„ç¶œåˆé›£åº¦è©•ç´š - ç”¨ğŸŸ¢ğŸŸ¡ğŸ”´ä¾†è¡¨ç¤º",
                    "guidance_level": "é«˜|ä¸­|ä½",
                    "difficulty_reason": "åˆ†ç´šç†ç”±"
                }}
            ]
        }}

        **æƒ…æ³äºŒï¼šå¦‚æœ content_type æ˜¯ study_material**
        {{
            "content_type": "study_material",
            "subject": "å¾ã€æº–å‰‡Aã€‘çš„å›ºå®šåˆ—è¡¨ä¸­é¸æ“‡çš„è€ƒç§‘åç¨±",
            "summary": "å­¸ç¿’è³‡æ–™çš„æ‘˜è¦ã€‚",
            "knowledge_points": ["å¾è³‡æ–™ä¸­æå–å‡ºçš„æ ¸å¿ƒçŸ¥è­˜é»1", "æ ¸å¿ƒçŸ¥è­˜é»2", "æ ¸å¿ƒçŸ¥è­˜é»3"]
        }}
        """
        
        # ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ (gemini-1.5-flash) é€²è¡Œå…§å®¹åˆ†é¡
        try:
            response = await self.secondary_model.generate_content_async(
                prompt,
                generation_config=self.generation_config
            )
            
            if response and response.text:
                result = extract_json_from_text(response.text)
                if result:
                    return result
                    
            # å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›é è¨­çš„å­¸ç¿’è³‡æ–™æ ¼å¼
            return {
                "content_type": "study_material",
                "subject": "å…¶ä»–",
                "summary": "å…§å®¹åˆ†æå¤±æ•—",
                "knowledge_points": []
            }
            
        except Exception as e:
            print(f"å…§å®¹åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return {
                "content_type": "study_material", 
                "subject": "å…¶ä»–",
                "summary": "åˆ†é¡éŒ¯èª¤",
                "knowledge_points": []
            }

    async def generate_questions_from_text(self, text: str, subject: str) -> List[Dict[str, Any]]:
        """
        æ ¹æ“šå®Œæ•´æ–‡æœ¬å…§å®¹ç”Ÿæˆé«˜å“è³ªç”³è«–æ¨¡æ“¬é¡Œï¼Œä¸¦ç‚ºæ¯å€‹å•é¡Œè‡ªå‹•æ¨™è¨»çŸ¥è­˜é»æ¨™ç±¤
        å°ˆæ³¨æ–¼ç”Ÿæˆéœ€è¦æ·±å…¥åˆ†æå’Œæ‡‰ç”¨çš„é¡Œç›®ï¼Œè€Œéå–®ç´”è¤‡è¿°çŸ¥è­˜
        """
        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„{subject}ç§‘ç”³è«–é¡Œå‡ºé¡Œå°ˆå®¶ã€‚è«‹æ ¹æ“šæä¾›çš„å­¸ç¿’è³‡æ–™ï¼Œè¨­è¨ˆ2-4é“é«˜å“è³ªçš„ç”³è«–æ¨¡æ“¬é¡Œã€‚

        **æ ¸å¿ƒè¦æ±‚ï¼š**
        1. **çµ•å°ç¦æ­¢**ç”Ÿæˆã€Œè«‹èªªæ˜...ã€ã€ã€Œè«‹è§£é‡‹...ã€ã€ã€Œè«‹è©³è¿°...ã€ã€ã€Œ...æ˜¯ä»€éº¼ã€ç­‰ç›´æ¥è¤‡è¿°å‹é¡Œç›®
        2. **å¿…é ˆå‰µé€ æ‡‰ç”¨æƒ…å¢ƒ**ï¼šæ¯é“é¡Œç›®éƒ½è¦è¨­è¨ˆä¸€å€‹è™›æ§‹ä½†åˆç†çš„å¯¦å‹™æƒ…å¢ƒ
        3. **è¦æ±‚æ·±åº¦åˆ†æ**ï¼šé¡Œç›®æ‡‰è©²æ¸¬è©¦å­¸ç”Ÿçš„åˆ†æã€æ¯”è¼ƒã€è©•ä¼°ã€è¨­è¨ˆèƒ½åŠ›
        4. **å¤šå…ƒæ€è€ƒ**ï¼šé¡Œç›®æ‡‰è©²å…è¨±å¤šè§’åº¦æ€è€ƒå’Œè«–è¿°

        **é‡è¦ï¼šé¡Œç›®æ ¼å¼è¦æ±‚**
        - **é¡Œç›®å…§å®¹**ï¼šåªèƒ½åŒ…å«æƒ…å¢ƒæè¿°å’Œå•é¡Œè¦æ±‚ï¼Œçµ•å°ä¸èƒ½åŒ…å«ç­”æ¡ˆæ­¥é©Ÿã€åˆ†æéç¨‹æˆ–è§£æ±ºæ–¹æ¡ˆ
        - **é¡Œç›®é•·åº¦**ï¼šæ‡‰è©²æ§åˆ¶åœ¨100-200å­—å…§ï¼Œç°¡æ½”æ˜ç¢º
        - **å•é¡Œå°å‘**ï¼šé¡Œç›®å¿…é ˆä»¥å•å¥çµå°¾ï¼Œå¦‚ã€Œè«‹åˆ†æ...ã€ã€ã€Œè©¦è«–è¿°...ã€ã€ã€Œè«‹æå‡º...ã€
        - **é—œæ–¼æ®µè½**ï¼šæ¯é“é¡Œç›®æ‡‰è©²åŒ…å«ä¸€å€‹æ¸…æ™°çš„æƒ…å¢ƒæè¿°æ®µè½ï¼Œç„¶å¾Œæ˜¯å•é¡Œè¦æ±‚æ®µè½ï¼Œç”¢ç”Ÿæ–°æ®µè½æ™‚ï¼Œå¿…é ˆä½¿ç”¨å…©å€‹é€£çºŒçš„æ›è¡Œç¬¦ï¼ˆ\n\nï¼‰ä¾†åˆ†éš”

        **é¡Œç›®è¨­è¨ˆåŸå‰‡ï¼š**
        - æƒ…å¢ƒå°å‘ï¼šå‰µé€ å…·é«”çš„å…¬å¸ã€çµ„ç¹”æˆ–å€‹äººæ¡ˆä¾‹
        - å•é¡Œè§£æ±ºï¼šè¦æ±‚å­¸ç”Ÿæå‡ºè§£æ±ºæ–¹æ¡ˆæˆ–å»ºè­°
        - æ‰¹åˆ¤æ€è€ƒï¼šè¦æ±‚åˆ†æå„ªç¼ºé»ã€æ¯”è¼ƒä¸åŒæ–¹æ³•
        - å¯¦å‹™æ‡‰ç”¨ï¼šå°‡ç†è«–çŸ¥è­˜æ‡‰ç”¨åˆ°å¯¦éš›æƒ…æ³

        **é¡Œç›®é›£åº¦åˆ†ç´šæ¨™æº–**
            *   è«‹æ ¹æ“šä»¥ä¸‹æ¨™æº–ï¼Œè¨­è¨ˆç”³è«–é¡Œé›£åº¦ã€‚
            *   **ğŸŸ¢ ç°¡å–®é¡Œç›®ï¼ˆé«˜å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šæ˜ç¢ºæŒ‡å®šåˆ†ææ¡†æ¶æˆ–æ–¹æ³•ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹èªªæ˜...ã€ã€ã€Œè«‹è§£é‡‹...ã€ã€ã€Œä¾æ“š...æ¡†æ¶ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šå®šç¾©å‹ã€èªªæ˜å‹ã€‚
            *   **ğŸŸ¡ ä¸­ç­‰é¡Œç›®ï¼ˆä¸­å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šæä¾›éƒ¨åˆ†å¼•å°ï¼Œä½†ä¸æŒ‡å®šå…·é«”åˆ†ææ¡†æ¶ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹åˆ†æ...ã€ã€ã€Œè«‹æ¯”è¼ƒ...ã€ã€ã€Œè«‹è©•ä¼°...ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šåˆ†æå‹ã€æ¯”è¼ƒå‹ã€‚
            *   **ğŸ”´ å›°é›£é¡Œç›®ï¼ˆä½å¼•å°ï¼‰**
                *   **ç‰¹å¾µ**ï¼šé–‹æ”¾æ€§å•é¡Œï¼Œéœ€è¦ç¶œåˆå¤šç¨®çŸ¥è­˜ã€‚
                *   **é—œéµè©**ï¼šã€Œè«‹è¨­è¨ˆ...ã€ã€ã€Œåˆ¶å®šç­–ç•¥...ã€ã€ã€Œæå‡ºè§£æ±ºæ–¹æ¡ˆ...ã€ã€‚
                *   **é¡Œç›®é¡å‹**ï¼šè¨­è¨ˆå‹ã€ç­–ç•¥å‹ã€ç¶œåˆæ‡‰ç”¨å‹ã€‚

        **å­¸ç¿’è³‡æ–™ï¼š**
        ```
        {text}
        ```

        **è«‹ä»¥JSONæ ¼å¼å›æ‡‰ï¼ŒåŒ…å«2-4é“ä¸åŒé›£åº¦çš„ç”³è«–é¡Œï¼š**
        {{
            "questions": [
                {{
                    "title": "ç°¡æ½”æ¨™é¡Œï¼ˆ5-8å€‹å­—ï¼‰",
                    "question": "ç´”ç²¹çš„é¡Œç›®å…§å®¹ï¼ˆåªåŒ…å«æƒ…å¢ƒæè¿°å’Œå•é¡Œè¦æ±‚ï¼Œä¸åŒ…å«ç­”æ¡ˆæˆ–åˆ†æéç¨‹ï¼‰",
                    "answer": "ç°¡æ½”çš„åƒè€ƒç­”æ¡ˆï¼ˆåŒ…å«æ ¸å¿ƒè¦é»ï¼Œ**å¿…é ˆæä¾›ï¼Œä¸å¯ç‚ºç©ºæˆ–ä½”ä½ç¬¦ï¼Œçµ•å°ä¸èƒ½å‡ºç¾ã€ŒThis is not included in the prompt.ã€æˆ–é¡ä¼¼çš„ä½”ä½ç¬¦ï¼Œä¾‹å¦‚ï¼š'This is not included in the prompt.' æˆ– 'The answer is not provided.'**ï¼‰",
                    "difficulty": "å°æ•´å€‹æ¨¡æ“¬é¡Œçš„ç¶œåˆé›£åº¦è©•ç´š -ç”¨ğŸŸ¢ğŸŸ¡ğŸ”´ä¾†è¡¨ç¤º ", 
                    "knowledge_points": ["ç›¸é—œçŸ¥è­˜é»1", "ç›¸é—œçŸ¥è­˜é»2", "ç›¸é—œçŸ¥è­˜é»3"],
                    "guidance_level": "å¼•å°ç¨‹åº¦ -ç”¨ é«˜|ä¸­|ä½ å›ç­”"ã€‚
                }}
            ]
        }}
        """
        parsed_json = await self._generate_with_json_parsing(prompt)
        return parsed_json.get("questions", []) if parsed_json else []

    async def generate_answer(self, question_text: str) -> Optional[Dict[str, Any]]:
        """
        æ ¹æ“šæä¾›çš„å•é¡Œæ–‡æœ¬ï¼Œç”Ÿæˆè©³ç´°çš„ç­”æ¡ˆã€‚

        Args:
            question_text: å•é¡Œçš„å®Œæ•´æ–‡å­—ã€‚

        Returns:
            ä¸€å€‹åŒ…å«ç­”æ¡ˆçš„å­—å…¸ï¼Œä¾‹å¦‚ï¼š{'answer': 'é€™æ˜¯è©³ç´°çš„å›ç­”...'}
        """
        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­ä¸”ç†Ÿæ‚‰å°ç£åœ‹è€ƒè³‡è¨Šè™•ç†è€ƒè©¦çš„è§£é¡Œè€å¸«ã€‚ä½ çš„ä»»å‹™æ˜¯**åš´æ ¼æ ¹æ“š**ä¸‹æ–¹æä¾›çš„å•é¡Œå…§å®¹ï¼Œé€²è¡Œåˆ†æèˆ‡æ›¸é¢ä½œç­”ã€‚

        â— **è«‹å‹™å¿…ä½¿ç”¨ç¹é«”ä¸­æ–‡ä½œç­”ï¼Œä¸”ç”¨è©éœ€è²¼è¿‘å°ç£æ…£ç”¨èªå½™èˆ‡æ›¸é¢ç”¨èªï¼Œä¸¦ç¬¦åˆå…¬è·è€ƒè©¦ã€è­‰ç…§è€ƒè©¦ç­‰å°ç£åœ‹è€ƒçš„ä½œç­”é¢¨æ ¼èˆ‡é‚è¼¯åš´è¬¹æ€§ã€‚**

        ---
        ğŸ§  **ä½ çš„æ€è€ƒæ­¥é©Ÿï¼š**
        1.  **é–±è®€èˆ‡å®šæ€§**ï¼šé€šè®€é¡Œç›®ï¼Œåˆ¤æ–·å…¶æ ¸å¿ƒé¡Œå‹ï¼ˆå®šç¾©ã€æ¯”è¼ƒã€è¨­è¨ˆã€åˆ†æç­‰ï¼‰ã€‚
        2.  **é—œéµå­—æå–**ï¼šæ‰¾å‡ºé¡Œç›®ä¸­çš„æ ¸å¿ƒé—œéµå­—å’Œé™åˆ¶æ¢ä»¶ã€‚
        3.  **çµæ§‹è¦åŠƒ**ï¼šæ ¹æ“šæˆ‘è…¦ä¸­çš„ã€Œç­–ç•¥å…ˆè¡Œã€åŸå‰‡ï¼Œè¦åŠƒå‡ºæœ¬æ¬¡ä½œç­”çš„å¤§ç¶±ï¼ˆæ¨™é¡Œä¸€ã€äºŒã€ä¸‰...ï¼‰ã€‚
        4.  **å…§å®¹å¡«å……**ï¼šä¾æ“šå¤§ç¶±ï¼Œé€æ­¥å¡«å……æ¯å€‹æ®µè½çš„å…§å®¹ï¼Œä¸¦å¾æˆ‘çš„ã€Œå·¥å…·ç®±ã€(a-f)ä¸­é¸ç”¨åˆé©çš„å…ƒç´ ã€‚
        5.  **æ ¼å¼å¯©æŸ¥**ï¼šæª¢æŸ¥ç·¨è™Ÿã€ç¸®æ’ã€ç¨‹å¼ç¢¼å€å¡Šä½¿ç”¨æ˜¯å¦å®Œå…¨ç¬¦åˆã€Œç‰ˆé¢è¦ç¯„ã€èˆ‡ã€Œç¨‹å¼ç¢¼å€å¡Šä½¿ç”¨æº–å‰‡ã€ã€‚
        6.  **æœ€çµ‚è¼¸å‡º**ï¼šç”Ÿæˆ JSON æ ¼å¼çš„æœ€çµ‚ç­”æ¡ˆã€‚
        ---

        ğŸ“˜ **å•é¡Œå…§å®¹ï¼š**
        {question_text}

        ---

        ğŸ“Œ **å›ç­”è¦ç¯„ï¼š**
        1.  **èªè¨€èˆ‡é¢¨æ ¼è¦æ±‚ï¼š**
            -   å¿…é ˆä½¿ç”¨**ç¹é«”ä¸­æ–‡**
            -   æ¡ç”¨**å°ç£åœ°å€æ…£ç”¨èªå½™**
            -   èªæ°£èˆ‡å…§å®¹éœ€ç¬¦åˆå°ç£**åœ‹å®¶è€ƒè©¦æˆ–è­‰ç…§è€ƒè©¦çš„æ¨™æº–è§£é¡Œé‚è¼¯èˆ‡æ›¸é¢é¢¨æ ¼**
            -   **ç¦æ­¢ä½¿ç”¨å£èªåŒ–ã€éæ­£å¼æˆ–éš¨æ„çš„èªæ°£ï¼Œåƒæ˜¯è¦ªæ„›çš„æœ‹å‹æ‚¨å¥½ï¼Œä»¥ä¸‹æ˜¯æœ‰é—œ... é€™æ¨£çš„å›ç­”æ–¹å¼æ˜¯ä¸å°çš„ï¼Œæ²’æœ‰äººæœƒåœ¨è€ƒå·ä¸Šé€™æ¨£å›ç­”**

        2.  **ç­–ç•¥å…ˆè¡Œï¼šæ ¹æ“šé¡Œå‹èª¿æ•´çµæ§‹**
            åœ¨å‹•ç­†å‰ï¼Œè«‹å…ˆåœ¨è…¦ä¸­åˆ¤æ–·æ­¤é¡Œçš„æ ¸å¿ƒé¡å‹ï¼Œä¸¦å„ªå…ˆé¸ç”¨æœ€é©åˆçš„ä½œç­”æ¶æ§‹ï¼š
            -   **å®šç¾©/èªªæ˜å‹**ï¼šå„ªå…ˆä½¿ç”¨ã€Œä¸€ã€å®šç¾©ã€ã€ã€ŒäºŒã€ä¸»è¦ç‰¹å¾µã€ã€ã€Œä¸‰ã€æ‡‰ç”¨ç¯„ä¾‹ã€çš„çµæ§‹ã€‚
            -   **æ¯”è¼ƒ/åˆ†æå‹**ï¼šå„ªå…ˆä½¿ç”¨ã€Œä¸€ã€å‰è¨€ã€ã€ã€ŒäºŒã€(Aæ–¹æ¡ˆ)èªªæ˜ã€ã€ã€Œä¸‰ã€(Bæ–¹æ¡ˆ)èªªæ˜ã€ã€ã€Œå››ã€æ¯”è¼ƒåˆ†æè¡¨ã€ã€ã€Œäº”ã€çµè«–å»ºè­°ã€çš„çµæ§‹ã€‚
            -   **è¨­è¨ˆ/ç­–ç•¥å‹**ï¼šå„ªå…ˆä½¿ç”¨ã€Œä¸€ã€å•é¡ŒèƒŒæ™¯èˆ‡ç›®æ¨™åˆ†æã€ã€ã€ŒäºŒã€è¨­è¨ˆåŸå‰‡/æ ¸å¿ƒç†å¿µã€ã€ã€Œä¸‰ã€å…·é«”æ–¹æ¡ˆæ¶æ§‹ï¼ˆå¯åŒ…å«åœ–ç¤º/è¡¨æ ¼èªªæ˜ï¼‰ã€ã€ã€Œå››ã€é æœŸæ•ˆç›Šèˆ‡é¢¨éšªè©•ä¼°ã€ã€ã€Œäº”ã€çµè«–ã€çš„çµæ§‹ã€‚
            -   **ä¸‹æ–¹ "çµæ§‹åŒ–ä½œç­”å…§å®¹" åˆ—è¡¨ç‚ºä½ çš„å·¥å…·ç®±ï¼Œè«‹æ ¹æ“šé¡Œå‹ç­–ç•¥æ€§åœ°é¸ç”¨ï¼Œè€Œéæ©Ÿæ¢°å¼åœ°å…¨éƒ¨ä½¿ç”¨ã€‚**

        3.  **é¡Œå‹é€šå‰‡è™•ç†ï¼š**
            -   æ‰€æœ‰å…§å®¹å¿…é ˆ**æ ¹æ“šé¡Œç›®æœ¬èº«åˆ†æ**ï¼Œä¸å¾—å¼•å…¥èˆ‡é¡Œç›®ç„¡é—œçš„å…§å®¹ã€‚
            -   è‹¥é¡Œç›®ä¸­å«æœ‰**è™›æ“¬ç¢¼ï¼ç¨‹å¼ç¢¼**ï¼Œè«‹ä¾ä¸‹æ–¹æ–¹å¼è™•ç†ï¼š
                a. å¿…é ˆ**å„ªå…ˆåˆ†æè©²ç¨‹å¼ç¢¼çš„é‚è¼¯èˆ‡é‹ä½œ**
                b. **ç¦æ­¢ä½¿ç”¨æœªå‡ºç¾åœ¨åŸé¡Œä¸­çš„æ¼”ç®—æ³•æˆ–é‚è¼¯é€²è¡Œæ›¿ä»£**
                c. è‹¥ç¨‹å¼ç¢¼æ ¼å¼æ··äº‚ï¼Œè«‹å…ˆä¿®æ­£æ›è¡Œèˆ‡ç¸®æ’ï¼Œå†é€²è¡Œåˆ†æ
            -   å›ç­”æ™‚ï¼Œè«‹æ ¼å¼åŒ–ï¼Œè«‹ä½¿ç”¨ Markdown èªæ³•ï¼Œç‰¹åˆ¥æ˜¯ç¨‹å¼ç¢¼å€å¡Šï¼ˆ```pseudocode ... ```ï¼‰ä¾†æ¸…æ™°å‘ˆç¾ç¨‹å¼ç¢¼ï¼Œä»¥åŠæ‰€æœ‰å¦‚æœåˆ—é»è«‹æ³¨æ„å±¤ç´šèˆ‡ç¸®æ’é‚„æœ‰æ¨™é¡Œã€ç·¨ç¢¼èˆ‡æ›è¡Œã€‚
            -   **é‡è¦Iï¼šç·¨è™Ÿæ ¼å¼è¦ç¯„**
                -   ä½¿ç”¨ä¸åŒå±¤ç´šçš„ç·¨è™Ÿï¼šç¬¬ä¸€å±¤ç”¨ã€Œä¸€ã€äºŒã€ä¸‰ã€ã€ï¼Œç¬¬äºŒå±¤ç”¨ã€Œ(ä¸€) (äºŒ) (ä¸‰)ã€ï¼Œç¬¬ä¸‰å±¤ç”¨ã€Œ1. 2. 3.ã€ï¼Œç¬¬å››å±¤ç”¨ã€Œ(1) (2) (3)ã€ã€‚
                -   ä½¿ç”¨ä¸åŒå±¤ç´šæ¨™é¡Œè«‹è¨˜å¾—ä½¿ç”¨markdownèªæ³•ï¼šã€Œ### ä¸€ã€ä¸»è¦åˆ†æã€ã€ã€Œ#### (ä¸€)è©³ç´°èªªæ˜ã€ä¾æ­¤é¡æ¨ã€‚
            -   **é‡è¦IIï¼šé¡Œç›®å›ç­”ç‰ˆé¢è¦ç¯„**
                -   **ç¦æ­¢:**å°‡æ•´ä»½ä½œç­”å…§å®¹å…¨éƒ¨æ”¾åœ¨ä¸€å€‹å¤§æ®µè½ä¸­ï¼Œå¿…é ˆä½¿ç”¨é©ç•¶çš„æ®µè½åˆ†éš”èˆ‡æ¨™é¡Œã€‚
                -   **åš´è¬¹:**æ¯å€‹æ®µè½éƒ½å¿…é ˆæœ‰æ¸…æ™°çš„ä¸»é¡Œå¥ï¼Œä¸¦ä¸”æ¯å€‹æ®µè½ä¹‹é–“è¦æœ‰é©ç•¶çš„ç©ºè¡Œåˆ†éš”ã€‚
                -   **æ¨™é¡Œ:**å‹™å¿…ä½¿ç”¨ Markdown èªæ³•ä¾†å¼·èª¿é‡è¦æ¦‚å¿µï¼ŒåŒæ™‚è¨˜å¾—æ›è¡Œå†é–‹å§‹æ®µè½ä¸»æ–‡ã€‚
                -   **å¼·èª¿:**å‹™å¿…ä½¿ç”¨ Markdown èªæ³•ä¾†æ¨™è¨˜é‡è¦çš„é—œéµè©æˆ–æ¦‚å¿µï¼Œä¾‹å¦‚ï¼š`**é‡è¦æ¦‚å¿µ**` æˆ– `*é—œéµè©*`ã€‚
                -   **ç¾è§€:**ç¢ºä¿æ•´é«”æ’ç‰ˆç¾è§€ï¼Œè®“é–±å·è€å¸«èƒ½å¤ è¼•é¬†é–±è®€ã€‚
            -   **é‡è¦IIIï¼šç¨‹å¼ç¢¼å€å¡Šä½¿ç”¨æº–å‰‡ (Heuristic for Code Block Usage)**
                -   **æ‡‰ä½¿ç”¨**ï¼šç•¶å…§å®¹ç‚ºçœŸå¯¦çš„ç¨‹å¼èªè¨€ (Python, SQL, C)ã€è™›æ“¬ç¢¼æ¼”ç®—æ³•ã€è¨­å®šæª” (JSON, YAML) æˆ–éœ€è¦é€è¡Œå°é½Šçš„è¿½è¹¤è¡¨æ ¼æ™‚ã€‚
                -   **æ‡‰é¿å…**ï¼šç•¶å…§å®¹åªæ˜¯ä¸€èˆ¬çš„é»åˆ—å¼èªªæ˜ã€ç‰¹å¾µåˆ—è¡¨æˆ–æ­¥é©Ÿæ¢åˆ—æ™‚ï¼Œ**å³ä½¿æœ‰ç·¨è™Ÿ**ï¼Œä¹Ÿæ‡‰ä½¿ç”¨æ¨™æº–çš„ Markdown åˆ—è¡¨ï¼ˆä¸€ã€ (ä¸€)ã€ 1.ï¼‰ï¼Œè€Œéç¨‹å¼ç¢¼å€å¡Šã€‚æ­¤èˆ‰æ˜¯ç‚ºäº†ç¢ºä¿æœ€ä½³çš„å¯è®€æ€§èˆ‡ç‰ˆé¢å‘ˆç¾ã€‚
            -   **é‡è¦IVï¼šè™•ç†æ¨¡ç³Šæ€§èˆ‡ä¸ç¢ºå®šæ€§**
                -   è‹¥é¡Œç›®ä¸­çš„æ¢ä»¶ä¸å¤ æ˜ç¢ºï¼Œæˆ–æœ‰å¤šç¨®å¯èƒ½çš„è§£é‡‹ï¼Œä½ **å¿…é ˆ**åœ¨å›ç­”ä¸­æ˜ç¢ºæŒ‡å‡ºä½ çš„ã€Œå‡è¨­å‰æã€ã€‚ä¾‹å¦‚ï¼šã€Œå‡è¨­é¡Œç›®æ‰€è¿°ä¹‹ã€ç³»çµ±ã€ç‚ºä¸€æ¨™æº–çš„ç·šä¸Šäº¤æ˜“è™•ç†ç³»çµ±ï¼ˆOLTPï¼‰ï¼Œå‰‡...ã€ã€‚
                -   **ç¦æ­¢**åœ¨æ²’æœ‰æ ¹æ“šçš„æƒ…æ³ä¸‹è‡ªè¡Œè…¦è£œæˆ–çŒœæ¸¬é¡Œç›®æ¢ä»¶ã€‚

        4.  **çµæ§‹åŒ–ä½œç­”å…§å®¹ï¼ˆä½ çš„å·¥å…·ç®±ï¼‰ï¼š**
            a. **ç¨‹å¼ç¢¼é‡ç¾**ï¼ˆè‹¥æœ‰ï¼‰ï¼šé‡æ–°æ’ç‰ˆé¡Œç›®å…§çš„è™›æ“¬ç¢¼ï¼Œä¿ç•™é‚è¼¯èˆ‡å¯è®€æ€§
            b. **æ¦‚å¿µèªªæ˜**ï¼šæ¸…æ¥šèªªæ˜èˆ‡é¡Œç›®ç›¸é—œçš„è³‡è¨Šæ¦‚å¿µï¼ˆå¦‚æ¼”ç®—æ³•ã€è³‡å®‰ã€ç¶²è·¯ã€è³‡æ–™åº«ã€è³‡ç®¡ç­‰ï¼‰
            c. **éç¨‹æ¨æ¼”**ï¼šè‹¥é¡Œç›®éœ€æ¼”ç®—æˆ–æµç¨‹æ¨å°ï¼Œè«‹åˆ—å‡ºæ¯ä¸€æ­¥éç¨‹èˆ‡èªªæ˜
            d. **è¤‡é›œåº¦ï¼é¢¨éšªåˆ†æ**ï¼šè‹¥æ¶‰åŠæ¼”ç®—æ³•æˆ–å®‰å…¨æ€§ï¼Œè«‹èªªæ˜æ™‚é–“/ç©ºé–“è¤‡é›œåº¦æˆ–æ½›åœ¨é¢¨éšª
            e. **è¡¨æ ¼è¼”åŠ©**ï¼ˆè‹¥é©ç”¨ï¼‰ï¼šå¯ä½¿ç”¨è¡¨æ ¼ä¾†è¼”-åŠ©æ¯”è¼ƒæˆ–æ•´ç†è³‡è¨Šï¼Œä½†**ä¸å¾—æ•´ä»½ä½œç­”çš†ç‚ºè¡¨æ ¼**ï¼Œéœ€æ­é…æ–‡å­—èªªæ˜å‘ˆç¾ã€‚
            f. **çµè«–**ï¼šé‡å°é¡Œç›®è¦æ±‚çµ¦å‡ºæ˜ç¢ºçµè«–æˆ–å»ºè­°

        5.  **å°ˆæ¥­æº–ç¢ºæ€§è¦æ±‚ï¼š**
            -   æ‰€æœ‰æ•˜è¿°éœ€æ­£ç¢ºç„¡èª¤
            -   ä¸å¯å‡ºç¾æƒ³åƒæ€§æè¿°æˆ–éŒ¯èª¤æ¨è«–

        6.  **åƒè€ƒè³‡æ–™ï¼ˆå¦‚æœ‰å¼•ç”¨ï¼‰ï¼š**
            -   æä¾› 1 è‡³ 3 ç­†å…·åƒè€ƒåƒ¹å€¼çš„ç¶²ç«™é€£çµ
            -   åƒè€ƒæ³•æ¢ **ï¼ˆè‹¥é©ç”¨ï¼‰**ï¼šè‹¥é¡Œç›®æ¶‰åŠæ³•å¾‹æˆ–è¦ç¯„ï¼Œè«‹å¼•ç”¨ç›¸é—œæ³•æ¢æˆ–è¦å®š

        ---

        ğŸ“¤ **è«‹ä»¥ä»¥ä¸‹ JSON çµæ§‹å›æ‡‰ï¼Œåˆ‡è¨˜å‹¿ç‚ºå›å‚³å…¶ä»–ä»»ä½•å…§å®¹æˆ–æ ¼å¼ï¼š**
        ```json
        {{
            "answer": "ï¼ˆè«‹åœ¨æ­¤å¡«å…¥ä½ çš„å®Œæ•´ç¹é«”ä¸­æ–‡æ›¸é¢ä½œç­”ï¼Œç¬¦åˆå°ç£è€ƒè©¦é¢¨æ ¼ï¼‰",
            "sources": [{{"url": "ä¾†æºé€£çµ", "title": "ç¶²ç«™æ¨™é¡Œ", "snippet": "ç°¡çŸ­èªªæ˜"}}]
        }}
"""
        return await self._generate_with_json_parsing(prompt) or {'answer': '', 'sources': []}

    async def generate_summary(self, text: str) -> Dict[str, Any]:
        """
        ç”Ÿæˆæ‘˜è¦
        """
        prompt = f"""
        è«‹ç‚ºä»¥ä¸‹å…§å®¹ç”Ÿæˆçµæ§‹åŒ–çš„çŸ¥è­˜é‡é»æ‘˜è¦ã€‚è«‹ç‰¹åˆ¥æ³¨æ„ï¼š

        1. **æå–è¡¨æ ¼è³‡è¨Š**ï¼šå¦‚æœå…§å®¹åŒ…å«è¡¨æ ¼ï¼Œè«‹å°‡è¡¨æ ¼è³‡è¨Šè½‰æ›ç‚ºæ¸…æ™°çš„é‡é»é …ç›®
        2. **æŠ€è¡“è¡“èªæ•´ç†**ï¼šå°‡å°ˆæ¥­è¡“èªã€æŠ€è¡“åç¨±ã€æ”»æ“Šæ‰‹æ³•ç­‰æ•´ç†æˆå­¸ç¿’è¦é»ï¼Œ**æ¯å€‹è¡“èªéƒ½è¦æä¾›ç°¡æ½”çš„è§£é‡‹**
        3. **é¿å…é‡è¤‡**ï¼šä¸è¦ç›´æ¥è¤‡è¿°åŸæ–‡ï¼Œè€Œæ˜¯è¦æ­¸ç´å‡ºé—œéµæ¦‚å¿µå’Œè¦é»
        4. **å¯¦ç”¨æ€§å°å‘**ï¼šé‡é»æ‡‰è©²æ˜¯ä¾¿æ–¼å­¸ç¿’å’Œè¨˜æ†¶çš„çŸ¥è­˜é»
        5. **åˆ†é¡æ•´ç†**ï¼šå°‡çŸ¥è­˜é»åˆ†ç‚ºæ ¸å¿ƒæ¦‚å¿µã€æŠ€è¡“è¡“èªã€åˆ†é¡è³‡è¨Šã€å¯¦å‹™æ‡‰ç”¨ç­‰é¡åˆ¥
        6. **å»å“ç‰ŒåŒ–**ï¼šé¿å…ä½¿ç”¨å…·é«”çš„å“ç‰Œåç¨±æˆ–ç”¢å“åç¨±ï¼Œå°ˆæ³¨æ–¼æŠ€è¡“å’Œæ¦‚å¿µæœ¬èº«ï¼Œé™¤éå“ç‰Œåç¨±æ˜¯å­¸ç¿’é‡é»çš„ä¸€éƒ¨åˆ†ã€‚

        **å…§å®¹ï¼š**
        {text[:6000]}

        è«‹ä»¥JSONæ ¼å¼å›æ‡‰ï¼Œç”Ÿæˆé«˜å“è³ªçš„å­¸ç¿’æ‘˜è¦ï¼š
        {{
            "summary": "ä¸€å¥è©±æ¦‚æ‹¬æ•´é«”å…§å®¹çš„æ ¸å¿ƒä¸»é¡Œ",
            "key_concepts": [
                {{"name": "æ ¸å¿ƒæ¦‚å¿µ1", "description": "ç°¡æ½”çš„è§£é‡‹èªªæ˜"}},
                {{"name": "æ ¸å¿ƒæ¦‚å¿µ2", "description": "ç°¡æ½”çš„è§£é‡‹èªªæ˜"}}
            ],
            "technical_terms": [
                {{"name": "æŠ€è¡“è¡“èª1", "description": "ä¸€å¥è©±è§£é‡‹é€™å€‹è¡“èªçš„å«ç¾©å’Œä½œç”¨"}},
                {{"name": "æŠ€è¡“è¡“èª2", "description": "ä¸€å¥è©±è§£é‡‹é€™å€‹è¡“èªçš„å«ç¾©å’Œä½œç”¨"}}
            ],
            "classification_info": [
                {{"name": "åˆ†é¡é …ç›®1", "description": "åˆ†é¡çš„è©³ç´°èªªæ˜æˆ–ç­‰ç´šå…§å®¹"}},
                {{"name": "åˆ†é¡é …ç›®2", "description": "åˆ†é¡çš„è©³ç´°èªªæ˜æˆ–ç­‰ç´šå…§å®¹"}}
            ],
            "practical_applications": [
                {{"name": "å¯¦å‹™æ‡‰ç”¨1", "description": "å…·é«”çš„æ‡‰ç”¨å ´æ™¯æˆ–å¯¦æ–½æ–¹æ³•"}},
                {{"name": "å¯¦å‹™æ‡‰ç”¨2", "description": "å…·é«”çš„æ‡‰ç”¨å ´æ™¯æˆ–å¯¦æ–½æ–¹æ³•"}}
            ],
            "bullets": ["æ•´åˆæ€§é‡é»1ï¼šåŒ…å«è©³ç´°èªªæ˜", "æ•´åˆæ€§é‡é»2ï¼šåŒ…å«è©³ç´°èªªæ˜", "æ•´åˆæ€§é‡é»3ï¼šåŒ…å«è©³ç´°èªªæ˜"]
        }}
        """
        parsed_json = await self._generate_with_json_parsing(prompt)
        if parsed_json and 'summary' in parsed_json and 'bullets' in parsed_json:
            return parsed_json
        return {"summary": "ç„¡æ³•ç”Ÿæˆæ‘˜è¦", "bullets": []}

    async def generate_quick_quiz(self, content: str, subject: str) -> List[Dict[str, Any]]:
        """ç”Ÿæˆå¿«é€Ÿæ¸¬é©—é¸æ“‡é¡Œ"""
        
        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„æ•™è‚²æ¸¬é©—è¨­è¨ˆå¸«ã€‚è«‹æ ¹æ“šä»¥ä¸‹å­¸ç¿’è³‡æ–™ï¼Œè¨­è¨ˆ5é“é¸æ“‡é¡Œä¾†å¿«é€Ÿæª¢é©—å­¸ç¿’è€…å°é‡é»çŸ¥è­˜çš„æŒæ¡ã€‚

        **è¨­è¨ˆåŸå‰‡ï¼š**
        1. é¡Œç›®æ‡‰è©²æ¸¬è©¦å°æ ¸å¿ƒæ¦‚å¿µçš„ç†è§£ï¼Œè€Œéç´°ç¯€è¨˜æ†¶
        2. é¿å…æ¶‰åŠå…·é«”çš„å…¬å¸åç¨±ã€ç”¢å“åç¨±æˆ–æ™‚äº‹æ–°è
        3. å°ˆæ³¨æ–¼çŸ¥è­˜é»æœ¬èº«çš„åŸç†ã€æ¦‚å¿µå’Œæ‡‰ç”¨
        4. æ¯é¡Œæä¾›4å€‹é¸é …ï¼Œå…¶ä¸­åªæœ‰1å€‹æ­£ç¢ºç­”æ¡ˆ
        5. æä¾›ç°¡æ½”æ˜ç¢ºçš„è§£æèªªæ˜

        **ç§‘ç›®é ˜åŸŸï¼š** {subject}

        **å­¸ç¿’è³‡æ–™ï¼š**
        {content}

        **è«‹ä»¥JSONæ ¼å¼å›æ‡‰ï¼ŒåŒ…å«5é“é¸æ“‡é¡Œï¼š**
        {{
            "quiz": [
                {{
                    "question": "é¡Œç›®å…§å®¹",
                    "type": "multiple_choice",
                    "options": ["A. é¸é …1", "B. é¸é …2", "C. é¸é …3", "D. é¸é …4"],
                    "correct_answer": "A",
                    "explanation": "è§£æèªªæ˜"
                }}
            ]
        }}
        """
        
        try:
            parsed_response = await self._generate_with_json_parsing(prompt)
            if parsed_response and 'quiz' in parsed_response:
                return parsed_response['quiz']
            else:
                print("è­¦å‘Šï¼šç„¡æ³•è§£æå¿«é€Ÿæ¸¬é©—JSONå›æ‡‰")
                return []
        except Exception as e:
            print(f"ç”Ÿæˆå¿«é€Ÿæ¸¬é©—éŒ¯èª¤: {e}")
            return []

    async def generate_mindmap(self, subject: str, knowledge_points: List[str], question_text: str = None) -> str:
        """
        æ ¹æ“šè¼¸å…¥çš„çŸ¥è­˜é»å’Œé¡Œç›®æ–‡æœ¬ï¼Œç”Ÿæˆ Mermaid.js æ ¼å¼çš„å¿ƒæ™ºåœ– Markdownã€‚
        
        Args:
            subject: ä¸»é¡Œ/ç§‘ç›®
            knowledge_points: çŸ¥è­˜é»åˆ—è¡¨
            question_text: é¡Œç›®æ–‡æœ¬ï¼ˆå¯é¸ï¼‰
        """
        # å°‡çŸ¥è­˜é»åˆ—è¡¨è½‰æ›ç‚º Mermaid ç¯€é»
        nodes_text = ""
        for kp in knowledge_points:
            # ç¢ºä¿ kp æ˜¯å­—ä¸²é¡å‹ï¼Œé˜²æ­¢ 'dict' object has no attribute 'replace' éŒ¯èª¤
            if isinstance(kp, dict):
                # å¦‚æœæ˜¯å­—å…¸ï¼Œå˜—è©¦æå–æœ‰æ„ç¾©çš„å­—ä¸²å€¼
                kp_str = kp.get('name', '') or kp.get('title', '') or kp.get('text', '') or str(kp)
            elif kp is None:
                continue  # è·³é None å€¼
            else:
                kp_str = str(kp)  # ç¢ºä¿æ˜¯å­—ä¸²
            
            # ç¢ºä¿çŸ¥è­˜é»ä¸å«ç ´å£æ ¼å¼çš„å­—å…ƒï¼Œä¸¦åŠ ä¸Šå¼•è™Ÿ
            safe_kp = kp_str.replace('\\', '\\\\').replace('"', '\"').replace('\n', ' ').replace('\r', '')
            nodes_text += f"""      "{safe_kp}"\n"""

        # æº–å‚™çŸ¥è­˜é»å­—ä¸²åˆ—è¡¨ç”¨æ–¼é¡¯ç¤º
        safe_knowledge_points = []
        for kp in knowledge_points:
            if isinstance(kp, dict):
                kp_str = kp.get('name', '') or kp.get('title', '') or kp.get('text', '') or str(kp)
            elif kp is None:
                continue
            else:
                kp_str = str(kp)
            if kp_str.strip():  # åªæ·»åŠ éç©ºå­—ä¸²
                safe_knowledge_points.append(kp_str.strip())

        # æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„çŸ¥è­˜é»
        if not safe_knowledge_points:
            print("è­¦å‘Šï¼šæ²’æœ‰æä¾›æœ‰æ•ˆçš„çŸ¥è­˜é»ï¼Œå°‡ä½¿ç”¨é è¨­å¿ƒæ™ºåœ–")
            return f"""mindmap
  root(("{subject}"))
    æç¤º("è«‹å…ˆæ·»åŠ çŸ¥è­˜é»")
      æ–¹æ³•1("ç·¨è¼¯é¡Œç›®æ™‚æ·»åŠ çŸ¥è­˜é»æ¨™ç±¤")
      æ–¹æ³•2("æˆ–ä¸Šå‚³ç›¸é—œå­¸ç¿’è³‡æ–™")
      æ–¹æ³•3("ç³»çµ±æœƒè‡ªå‹•æå–çŸ¥è­˜é»")"""

        # é è™•ç†é¡Œç›®æ–‡æœ¬ï¼Œè™•ç†å¯èƒ½å°è‡´ API å•é¡Œçš„å…§å®¹
        processed_question_text = None
        question_summary = None
        
        if question_text and question_text.strip():
            processed_question_text = self._preprocess_question_text(question_text)
            # å¦‚æœè™•ç†å¾Œçš„æ–‡æœ¬å¤ªçŸ­æˆ–å¯èƒ½æœ‰å•é¡Œï¼Œå‰‡ä¸ä½¿ç”¨é¡Œç›®æ–‡æœ¬
            if not processed_question_text or len(processed_question_text.strip()) < 10:
                processed_question_text = None
            else:
                # ç”Ÿæˆé¡Œç›®æ‘˜è¦èˆ‡è§£é¡ŒæŠ€å·§
                print("æ­£åœ¨ç”Ÿæˆé¡Œç›®æ‘˜è¦èˆ‡è§£é¡ŒæŠ€å·§...")
                summary_result = await self.generate_question_summary(processed_question_text, subject)
                question_summary = summary_result

        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„çŸ¥è­˜æ•´åˆèˆ‡è¦–è¦ºåŒ–å°ˆå®¶ï¼Œå°ˆç²¾æ–¼å°‡é›¶æ•£çš„çŸ¥è­˜é»è½‰æ›ç‚ºçµæ§‹æ¸…æ™°ã€é‚è¼¯åˆ†æ˜çš„ Mermaid.js å¿ƒæ™ºåœ–ã€‚

        ğŸ§  **ä½ çš„æ ¸å¿ƒä»»å‹™èˆ‡æ€è€ƒæ­¥é©Ÿï¼š**
            1.  **æ·±åº¦åˆ†æ**ï¼šé¦–å…ˆï¼Œä»”ç´°åˆ†æä¸‹æ–¹æä¾›çš„ã€Œé¡Œç›®æ‘˜è¦ã€ã€ã€Œè§£é¡ŒæŠ€å·§ã€ï¼ˆå¦‚æœ‰ï¼‰å’Œæ‰€æœ‰ã€ŒçŸ¥è­˜é»ã€ï¼Œç†è§£å®ƒå€‘å„è‡ªçš„å«ç¾©å’Œç›¸äº’é—œè¯ã€‚
            2.  **é¡Œç›®å°å‘æ•´åˆ**ï¼šå¦‚æœæœ‰æä¾›é¡Œç›®æ‘˜è¦ï¼Œè«‹ç‰¹åˆ¥é—œæ³¨å…¶ä¸­æ¶‰åŠçš„æ ¸å¿ƒæ¦‚å¿µã€æŠ€è¡“è¦ç´ ã€å’Œå•é¡Œå ´æ™¯ï¼Œå°‡é€™äº›èˆ‡çŸ¥è­˜é»é€²è¡Œé—œè¯åˆ†æã€‚
            3.  **æ™ºèƒ½æ­¸ç´èˆ‡åˆ†é¡**ï¼šæ ¹æ“šé¡Œç›®è„ˆçµ¡å’ŒçŸ¥è­˜é»çš„å…§åœ¨é—œè¯ï¼Œæ‰¾å‡º 3 åˆ° 5 å€‹æœ€åˆé©çš„ã€Œé«˜éšé‚è¼¯åˆ†é¡ã€ã€‚é€™äº›åˆ†é¡æ‡‰è©²æ˜¯å°çŸ¥è­˜é»çš„æœ‰æ•ˆæ­¸ç´ï¼Œä¸¦åæ˜ é¡Œç›®çš„æ ¸å¿ƒä¸»é¡Œã€‚
            4.  **å»ºç«‹å±¤ç´šçµæ§‹**ï¼šä»¥ã€Œæ ¸å¿ƒä¸»é¡Œã€ç‚ºæ ¹ç¯€é»ï¼Œä»¥ä½ æ­¸ç´å‡ºçš„ã€Œé«˜éšé‚è¼¯åˆ†é¡ã€ç‚ºä¸»è¦åˆ†æ”¯ï¼Œç„¶å¾Œå°‡åŸå§‹çš„ã€ŒçŸ¥è­˜é»ã€ä½œç‚ºé€™äº›åˆ†æ”¯ä¸‹çš„å­ç¯€é»ï¼ˆè‘‰ç¯€é»ï¼‰ã€‚
            5.  **èªæ³•ç”Ÿæˆèˆ‡é©—è­‰**ï¼šå°‡é€™å€‹å±¤ç´šçµæ§‹ç²¾ç¢ºåœ°è½‰æ›ç‚º Mermaid.js çš„ mindmap èªæ³•ã€‚åœ¨è¼¸å‡ºå‰ï¼Œç¢ºä¿èªæ³•ç„¡èª¤ï¼Œæ‰€æœ‰å¼•è™Ÿéƒ½å·²æ­£ç¢ºé–‰åˆã€‚
            6.  **ç´”æ·¨è¼¸å‡º**ï¼šåªå›å‚³ç´”ç²¹çš„ Mermaid ç¨‹å¼ç¢¼ï¼Œä¸åŒ…å«ä»»ä½•é¡å¤–çš„è§£é‡‹æˆ– ```mermaid ... ``` æ¨™è¨˜ã€‚

            ---

        **ç¯„ä¾‹ï¼šä¸€å€‹å„ªç§€çš„åˆ†é¡èˆ‡å±¤ç´šçµæ§‹**
            ä¸‹é¢æ˜¯ä¸€å€‹ç†æƒ³çš„è¼¸å‡ºç¯„ä¾‹ï¼Œå®ƒå±•ç¤ºäº†å¦‚ä½•å°‡çŸ¥è­˜é»é€²è¡Œæ­¸ç´åˆ†é¡ï¼Œè€Œä¸æ˜¯ç°¡å–®åœ°å¹³é‹ªç›´æ•˜ã€‚

            *   **è¼¸å…¥ä¸»é¡Œ**ï¼šè³‡è¨Šç®¡ç†
            *   **è¼¸å…¥çŸ¥è­˜é»**ï¼š["è³‡æ–™åº«ç®¡ç†ç³»çµ±", "è³‡è¨Šç³»çµ±é–‹ç™¼ç”Ÿå‘½é€±æœŸ", "ä¼æ¥­è³‡æºè¦åŠƒ (ERP)", "å®¢æˆ¶é—œä¿‚ç®¡ç† (CRM)", "å•†æ¥­æ™ºæ…§ (BI)", "è³‡è¨Šå®‰å…¨", "å°ˆæ¡ˆç®¡ç†"]
            *   **æ­£ç¢ºè¼¸å‡º**ï¼š
                mindmap
                    root(("è³‡è¨Šç®¡ç†"))
                        ç³»çµ±("è³‡è¨Šç³»çµ±")
                            ç³»çµ±å­("è³‡æ–™åº«ç®¡ç†ç³»çµ±")
                            ç³»çµ±å­("è³‡è¨Šç³»çµ±é–‹ç™¼ç”Ÿå‘½é€±æœŸ")
                        ç®¡ç†("ç®¡ç†ç³»çµ±")
                            ç®¡ç†å­("ä¼æ¥­è³‡æºè¦åŠƒ (ERP)")
                            ç®¡ç†å­("å®¢æˆ¶é—œä¿‚ç®¡ç† (CRM)")
                            ç®¡ç†å­("ä¾›æ‡‰éˆç®¡ç† (SCM)")
                            ç®¡ç†å­("çŸ¥è­˜ç®¡ç† (KM)")
                        åˆ†æ("åˆ†æèˆ‡é‹ç®—")
                            åˆ†æå­("å•†æ¥­æ™ºæ…§ (BI)")
                            åˆ†æå­("å¤§æ•¸æ“šèˆ‡åˆ†æ")
                            åˆ†æå­("é›²ç«¯é‹ç®—")
                        å…¶ä»–("å…¶ä»–")
                            å…¶ä»–å­("è³‡è¨Šå®‰å…¨")
                            å…¶ä»–å­("è³‡è¨Šå€«ç†èˆ‡æ³•å¾‹")
                            å…¶ä»–å­("å°ˆæ¡ˆç®¡ç†")

            ---

        **ç¾åœ¨ï¼Œè«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™ï¼ŒåŸ·è¡Œä½ çš„ä»»å‹™ï¼š**

        **æ ¸å¿ƒä¸»é¡Œï¼š** {subject}
        é™„è¨»ï¼šæ ¸å¿ƒä¸»é¡Œåªæ˜¯é€™ä¸€è€ƒè©¦é¡Œç›®çš„ç§‘ç›®åˆ†é¡ï¼Œä¸ä¸€å®šè¦ç•¶ä½œæ ¹ç¯€é»ã€‚
        
        {f'''**é¡Œç›®æ‘˜è¦ï¼š**
        {question_summary.get('summary', 'ç„¡')}
        
        **è§£é¡ŒæŠ€å·§ï¼š**
        {question_summary.get('solving_tips', 'ç„¡')}
        
        é™„è¨»ï¼šè«‹å°‡é¡Œç›®æ‘˜è¦ä¸­çš„æ ¸å¿ƒæ¦‚å¿µå’Œè§£é¡ŒæŠ€å·§ä¸­çš„é—œéµè¦ç´ èå…¥å¿ƒæ™ºåœ–çµæ§‹ï¼Œè®“å¿ƒæ™ºåœ–æ›´è²¼è¿‘å¯¦éš›è€ƒè©¦éœ€æ±‚ã€‚
        ''' if question_summary else ''}
            
        **çŸ¥è­˜é»ï¼š**
        {', '.join(safe_knowledge_points)}
        
        è«‹ç›´æ¥è¼¸å‡º Mermaid ç¨‹å¼ç¢¼ï¼Œä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„è§£é‡‹æˆ– ```mermaid ... ``` æ¨™è¨˜ã€‚
        """
        # å°æ–¼å¿ƒæ™ºåœ–ï¼Œæˆ‘å€‘ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ (gemini-1.5-flash)
        try:
            # å»ºç«‹ä¸€å€‹ä¸è¦æ±‚ JSON çš„ç”Ÿæˆè¨­å®š
            text_generation_config = genai.types.GenerationConfig(
                temperature=0.3,
                top_p=0.9,
                max_output_tokens=2048,
            )
            response = await asyncio.to_thread(
                self.secondary_model.generate_content,
                prompt,
                generation_config=text_generation_config
            )
            
            # æ¸…ç†å›æ‡‰ï¼Œç¢ºä¿æ˜¯åˆæ³•çš„ Mermaid ä»£ç¢¼
            mermaid_code = response.text.strip()
            
            # è™•ç†å¯èƒ½è¢«åŒ…è£¹åœ¨ markdown ä»£ç¢¼å¡Šä¸­çš„å›æ‡‰
            if mermaid_code.startswith("```mermaid") or mermaid_code.startswith("```"):
                # ç§»é™¤é–‹é ­çš„ ```mermaid æˆ– ```
                lines = mermaid_code.split('\n')
                if lines[0].startswith("```"):
                    lines = lines[1:]  # ç§»é™¤ç¬¬ä¸€è¡Œ
                # ç§»é™¤çµå°¾çš„ ```
                if lines and lines[-1].strip() == "```":
                    lines = lines[:-1]  # ç§»é™¤æœ€å¾Œä¸€è¡Œ
                mermaid_code = '\n'.join(lines).strip()
            
            # æª¢æŸ¥æ¸…ç†å¾Œçš„ä»£ç¢¼æ˜¯å¦ä»¥ mindmap é–‹é ­
            if not mermaid_code.startswith("mindmap"):
                print(f"è­¦å‘Šï¼šGemini å›æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ mindmap æ ¼å¼ (é•·åº¦: {len(mermaid_code)})")
                return "mindmap\n  root((ç”Ÿæˆå¤±æ•—))\n    è«‹æª¢æŸ¥è¼¸å…¥å…§å®¹æˆ– API é€£ç·š"
            
            return mermaid_code
        except Exception as e:
            print(f"ç”Ÿæˆå¿ƒæ™ºåœ–æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return "mindmap\n  root((éŒ¯èª¤))\n    ç„¡æ³•ç”Ÿæˆå¿ƒæ™ºåœ–"

    async def generate_question_summary(self, question_text: str, question_title: str = "") -> Dict[str, str]:
        """
        ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ç”Ÿæˆé¡Œç›®æ‘˜è¦èˆ‡è§£é¡ŒæŠ€å·§
        
        Args:
            question_text: é¡Œç›®å…§å®¹
            question_title: é¡Œç›®æ¨™é¡Œ
            
        Returns:
            åŒ…å«æ‘˜è¦å’Œè§£é¡ŒæŠ€å·§çš„å­—å…¸
        """
        try:
            prompt = f"""
è«‹ç‚ºä»¥ä¸‹è€ƒè©¦é¡Œç›®ç”Ÿæˆç°¡æ½”çš„æ‘˜è¦èˆ‡è§£é¡ŒæŠ€å·§ï¼š

é¡Œç›®æ¨™é¡Œ: {question_title}
é¡Œç›®å…§å®¹: {question_text}

è«‹ä»¥ä»¥ä¸‹JSONæ ¼å¼å›æ‡‰ï¼š
{{
    "summary": "é¡Œç›®çš„æ ¸å¿ƒæ¦‚å¿µæ‘˜è¦ (50å­—ä»¥å…§)",
    "solving_tips": "é—œéµè§£é¡ŒæŠ€å·§èˆ‡æ³¨æ„äº‹é … (100å­—ä»¥å…§)"
}}

è¦æ±‚ï¼š
1. æ‘˜è¦è¦æŠ“ä½é¡Œç›®çš„æ ¸å¿ƒçŸ¥è­˜é»
2. è§£é¡ŒæŠ€å·§è¦å¯¦ç”¨ä¸”ç°¡æ½”
3. é¿å…å†—é•·çš„è§£é‡‹
4. å°ˆæ³¨æ–¼è€ƒè©¦é‡é»
"""
            
            # ä½¿ç”¨è¼•é‡ç´šæ¨¡å‹ (gemini-1.5-flash) ä¸¦ä½¿ç”¨ JSON é…ç½®
            json_config = genai.types.GenerationConfig(
                temperature=0.2,
                top_p=0.9,
                max_output_tokens=1024,
                response_mime_type="application/json"
            )
            response = await asyncio.to_thread(
                self.secondary_model.generate_content,
                prompt,
                generation_config=json_config
            )
            
            if response and response.text:
                result = extract_json_from_text(response.text)
                if result and 'summary' in result and 'solving_tips' in result:
                    return result
                    
            # å¦‚æœè§£æå¤±æ•—ï¼Œè¿”å›é è¨­å€¼
            return {
                "summary": "é¡Œç›®æ‘˜è¦ç”Ÿæˆå¤±æ•—",
                "solving_tips": "è«‹åƒè€ƒé¡Œç›®å…§å®¹é€²è¡Œåˆ†æ"
            }
            
        except Exception as e:
            print(f"ç”Ÿæˆé¡Œç›®æ‘˜è¦æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return {
                "summary": "æ‘˜è¦ç”ŸæˆéŒ¯èª¤",
                "solving_tips": "è«‹æª¢æŸ¥é¡Œç›®å…§å®¹"
            }

    def _preprocess_question_text(self, question_text: str) -> str:
        """
        é è™•ç†é¡Œç›®æ–‡æœ¬ï¼Œç§»é™¤å¯èƒ½å°è‡´ API å•é¡Œçš„å…§å®¹
        
        Args:
            question_text: åŸå§‹é¡Œç›®æ–‡æœ¬
            
        Returns:
            è™•ç†å¾Œçš„é¡Œç›®æ–‡æœ¬
        """
        if not question_text:
            return ""
            
        # è¤‡è£½åŸæ–‡æœ¬é€²è¡Œè™•ç†
        processed = question_text.strip()
        
        # ç§»é™¤æˆ–ç°¡åŒ–è™›æ“¬ç¢¼å€å¡Š
        import re
        
        # æ¨¡å¼1: ç§»é™¤ ```pseudocode ... ``` ä»£ç¢¼å¡Š
        processed = re.sub(r'```pseudocode.*?```', '[è™›æ“¬ç¢¼æ¼”ç®—æ³•]', processed, flags=re.DOTALL)
        
        # æ¨¡å¼2: ç§»é™¤ ```...``` ä»£ç¢¼å¡Š
        processed = re.sub(r'```.*?```', '[ç¨‹å¼ç¢¼å€å¡Š]', processed, flags=re.DOTALL)
        
        # ç§»é™¤éé•·çš„é‡è¤‡æ›è¡Œ
        processed = re.sub(r'\n{3,}', '\n\n', processed)
        
        # ç§»é™¤å¯èƒ½æœ‰å•é¡Œçš„ç‰¹æ®Šå­—ç¬¦çµ„åˆ
        processed = re.sub(r'[^\w\s\u4e00-\u9fff.,;:!?()[\]{}+=\-*/\'"ï¼Œã€‚ï¼›ï¼šï¼ï¼Ÿï¼ˆï¼‰ã€ã€‘ï½›ï½]', ' ', processed)
        
        # é™åˆ¶é•·åº¦ï¼Œé¿å…éé•·çš„æ–‡æœ¬
        if len(processed) > 300:
            # åªå–å‰300å­—ç¬¦ï¼Œä¸¦åœ¨å¥è™Ÿæˆ–å•è™Ÿè™•æˆªæ–·
            truncated = processed[:300]
            # æ‰¾åˆ°æœ€å¾Œä¸€å€‹å¥è™Ÿæˆ–å•è™Ÿçš„ä½ç½®
            last_punct = max(truncated.rfind('ã€‚'), truncated.rfind('ï¼Ÿ'), truncated.rfind('ï¼'), truncated.rfind('.'), truncated.rfind('?'), truncated.rfind('!'))
            if last_punct > 100:  # ç¢ºä¿ä¸æœƒæˆªå¾—å¤ªçŸ­
                processed = truncated[:last_punct + 1]
            else:
                processed = truncated + "..."
        
        # æ¸…ç†å¤šé¤˜çš„ç©ºç™½
        processed = ' '.join(processed.split())
        
        return processed

    async def extract_knowledge_points(self, text: str, subject: str) -> Optional[List[str]]:
        """å¾æ–‡æœ¬ä¸­æå–çŸ¥è­˜é»"""
        prompt = f"""
        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„{subject}ç§‘è€å¸«ï¼Œä½ çš„ä»»å‹™æ˜¯å¾çµ¦å®šçš„è€ƒè©¦é¡Œç›®æˆ–æ–‡æœ¬ä¸­ï¼Œç²¾æº–åœ°æå–å‡ºæ ¸å¿ƒçš„ã€ŒçŸ¥è­˜é»ã€ã€‚

        **ä»»å‹™èªªæ˜ï¼š**
        1.  **åˆ†ææ–‡æœ¬**ï¼šä»”ç´°é–±è®€ä»¥ä¸‹å…§å®¹ã€‚
        2.  **æå–çŸ¥è­˜é»**ï¼šè­˜åˆ¥å‡ºæ–‡æœ¬æ‰€æ¸¬é©—çš„2åˆ°5å€‹æœ€é‡è¦ã€æœ€æ ¸å¿ƒçš„è§€å¿µæˆ–è¡“èªã€‚çŸ¥è­˜é»æ‡‰è©²æ˜¯ç°¡æ½”ã€å…·é«”çš„åè©æˆ–çŸ­èªã€‚
        3.  **æ ¼å¼åŒ–è¼¸å‡º**ï¼šå°‡æå–çš„çŸ¥è­˜é»ä»¥JSONæ ¼å¼è¼¸å‡ºã€‚

        **æ–‡æœ¬å…§å®¹ï¼š**
        ```
        {text}
        ```

        **è¼¸å‡ºè¦æ±‚ï¼š**
        -   å¿…é ˆæ˜¯åš´æ ¼çš„JSONæ ¼å¼ã€‚
        -   JSONç‰©ä»¶æ‡‰åŒ…å«ä¸€å€‹éµ `knowledge_points`ã€‚
        -   `knowledge_points` çš„å€¼æ‡‰è©²æ˜¯ä¸€å€‹å­—ä¸²åˆ—è¡¨ï¼Œæ¯å€‹å­—ä¸²å°±æ˜¯ä¸€å€‹çŸ¥è­˜é»ã€‚

        **ç¯„ä¾‹ï¼š**
        -   **è¼¸å…¥æ–‡æœ¬ï¼ˆå…¬æ°‘èˆ‡ç¤¾æœƒï¼‰**ï¼šã€Œæ ¹æ“šæˆ‘åœ‹ã€Šå…¬å¸æ³•ã€‹è¦å®šï¼Œè‚¡æ±æœƒæ˜¯å…¬å¸çš„æœ€é«˜æ¬ŠåŠ›æ©Ÿæ§‹ã€‚è«‹å•ï¼Œè‹¥Aå…¬å¸æ±ºå®šé€²è¡Œåˆä½µï¼Œæ‡‰ç”±å“ªå€‹æ©Ÿæ§‹æ±ºè­°ï¼Ÿã€
        -   **è¼¸å‡ºJSON**ï¼š
            ```json
            {{
                "knowledge_points": [
                    "å…¬å¸æ³•",
                    "è‚¡æ±æœƒè·æ¬Š",
                    "å…¬å¸åˆä½µ"
                ]
            }}
            ```
        -   **è¼¸å…¥æ–‡æœ¬ï¼ˆç‰©ç†ï¼‰**ï¼šã€Œä¸€å€‹è³ªé‡ç‚º2å…¬æ–¤çš„ç‰©é«”ï¼Œåœ¨å…‰æ»‘æ°´å¹³é¢ä¸Šå—åˆ°10ç‰›é “çš„æ°´å¹³åŠ›ä½œç”¨ï¼Œè«‹å•å…¶åŠ é€Ÿåº¦ç‚ºä½•ï¼Ÿã€
        -   **è¼¸å‡ºJSON**ï¼š
            ```json
            {{
                "knowledge_points": [
                    "ç‰›é “ç¬¬äºŒé‹å‹•å®šå¾‹",
                    "F=ma",
                    "åŠ é€Ÿåº¦è¨ˆç®—"
                ]
            }}
            ```

        è«‹ç¾åœ¨åˆ†æçµ¦å®šçš„æ–‡æœ¬ä¸¦è¿”å›JSONçµæœã€‚
        """
        
        parsed_json = await self._generate_with_json_parsing(prompt)
        if parsed_json and 'knowledge_points' in parsed_json and isinstance(parsed_json['knowledge_points'], list):
            return parsed_json['knowledge_points']
        
        print(f"ç„¡æ³•å¾å›æ‡‰ä¸­è§£æå‡ºçŸ¥è­˜é»: {parsed_json}")
        return None

    async def generate_tags(self, text: str, subject: str) -> List[str]:
        """ç”Ÿæˆæ¨™ç±¤"""
        prompt = f"""
        åŸºæ–¼ä»¥ä¸‹ã€Œ{subject}ã€é ˜åŸŸçš„å…§å®¹ï¼Œè«‹ç”Ÿæˆ3-6å€‹ç²¾ç¢ºä¸”æœ‰ä»£è¡¨æ€§çš„æ¨™ç±¤é—œéµå­—ã€‚
        æ¨™ç±¤æ‡‰è©²æ˜¯å¸¸è¦‹çš„æŠ€è¡“è¡“èªã€æ¦‚å¿µæˆ–æ¨™æº–ã€‚

        å…§å®¹ï¼š
        {text[:2000]}

        è«‹ä»¥JSONæ ¼å¼å›æ‡‰ï¼š
        {{
            "tags": ["æ¨™ç±¤1", "æ¨™ç±¤2", "æ¨™ç±¤3", ...]
        }}
        """
        parsed_json = await self._generate_with_json_parsing(prompt)
        if parsed_json and 'tags' in parsed_json:
            return parsed_json.get("tags", [])
        return []