{% extends 'layout.html' %}
{% block title %}å­¸ç¿’æ‘˜è¦æ¸¬é©— - è€ƒé¡ŒçŸ¥è­˜æ•´ç†ç³»çµ±{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="text-center mb-5">
            <h1 class="display-4 mb-4">ğŸ“ å­¸ç¿’æ‘˜è¦æ¸¬é©—</h1>
            <p class="lead text-muted">æ ¹æ“šçŸ¥è­˜é»ç”Ÿæˆå€‹äººåŒ–æ¸¬é©—ï¼Œå¿«é€Ÿæª¢é©—å­¸ç¿’æˆæœ</p>
        </div>

        <!-- æ¸¬é©—è¨­å®šå€åŸŸ -->
        <div class="card mb-4" id="quiz-setup">
            <div class="card-header">
                <h3 class="card-title mb-0">ğŸ“‹ æ¸¬é©—è¨­å®š</h3>
            </div>
            <div class="card-body">
                <form id="quiz-form">
                    <!-- çŸ¥è­˜é»é¸æ“‡ -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">é¸æ“‡çŸ¥è­˜é» <span class="text-danger">*</span></label>
                        <div class="row">
                            {% if knowledge_points %}
                                {% for kp in knowledge_points %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{ kp[0] }}" id="kp_{{ kp[0] }}" name="knowledge_points">
                                        <label class="form-check-label" for="kp_{{ kp[0] }}">
                                            <strong>{{ kp[1] }}</strong>
                                            {% if kp[2] %}<small class="text-muted">({{ kp[2] }})</small>{% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        ç›®å‰æ²’æœ‰å¯ç”¨çš„çŸ¥è­˜é»ã€‚è«‹å…ˆ<a href="/upload" class="alert-link">ä¸Šå‚³å­¸ç¿’è³‡æ–™</a>ä¾†å»ºç«‹çŸ¥è­˜é»ã€‚
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- æ¸¬é©—é¡å‹é¸æ“‡ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="quiz_type" class="form-label fw-bold">æ¸¬é©—é¡å‹</label>
                            <select class="form-select" id="quiz_type" name="quiz_type">
                                <option value="multiple_choice">é¸æ“‡é¡Œ</option>
                                <option value="true_false">æ˜¯éé¡Œ</option>
                                <option value="fill_blank">å¡«ç©ºé¡Œ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="num_questions" class="form-label fw-bold">é¡Œç›®æ•¸é‡</label>
                            <select class="form-select" id="num_questions" name="num_questions">
                                <option value="3">3 é¡Œ</option>
                                <option value="5" selected>5 é¡Œ</option>
                                <option value="10">10 é¡Œ</option>
                                <option value="15">15 é¡Œ</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç”ŸæˆæŒ‰éˆ• -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-warning btn-lg" id="generate-btn">
                            <i class="fas fa-magic"></i> ç”Ÿæˆæ¸¬é©—
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¼‰å…¥ä¸­æç¤º -->
        <div class="card d-none" id="loading-card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-warning mb-3" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <h4>ğŸ§  AI æ­£åœ¨ç”Ÿæˆæ¸¬é©—é¡Œç›®...</h4>
                <p class="text-muted">è«‹ç¨å€™ï¼Œé€™å¯èƒ½éœ€è¦å¹¾ç§’é˜çš„æ™‚é–“</p>
            </div>
        </div>

        <!-- æ¸¬é©—å€åŸŸ -->
        <div class="card d-none" id="quiz-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">ğŸ¯ é–‹å§‹æ¸¬é©—</h3>
                <button class="btn btn-outline-secondary btn-sm" id="restart-btn">
                    <i class="fas fa-redo"></i> é‡æ–°è¨­å®š
                </button>
            </div>
            <div class="card-body">
                <div id="quiz-content">
                    <!-- æ¸¬é©—é¡Œç›®å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-success btn-lg d-none" id="submit-quiz-btn">
                        <i class="fas fa-check"></i> æäº¤ç­”æ¡ˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- çµæœå€åŸŸ -->
        <div class="card d-none" id="result-card">
            <div class="card-header">
                <h3 class="card-title mb-0">ğŸ“Š æ¸¬é©—çµæœ</h3>
            </div>
            <div class="card-body">
                <div id="result-content">
                    <!-- çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-primary" id="new-quiz-btn">
                        <i class="fas fa-plus"></i> æ–°æ¸¬é©—
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuiz = null;
let userAnswers = {};

document.getElementById('quiz-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // å–å¾—é¸æ“‡çš„çŸ¥è­˜é»
    const selectedKnowledge = Array.from(document.querySelectorAll('input[name="knowledge_points"]:checked'))
        .map(cb => parseInt(cb.value));
    
    if (selectedKnowledge.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹çŸ¥è­˜é»ï¼');
        return;
    }
    
    const quizType = document.getElementById('quiz_type').value;
    const numQuestions = parseInt(document.getElementById('num_questions').value);
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById('quiz-setup').classList.add('d-none');
    document.getElementById('loading-card').classList.remove('d-none');
    
    try {
        const response = await fetch('/generate-quiz', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                knowledge_points: selectedKnowledge,
                quiz_type: quizType,
                num_questions: numQuestions
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        currentQuiz = data;
        userAnswers = {};
        
        // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºæ¸¬é©—
        document.getElementById('loading-card').classList.add('d-none');
        document.getElementById('quiz-card').classList.remove('d-none');
        
        // æ¸²æŸ“æ¸¬é©—é¡Œç›®
        renderQuiz(data);
        
    } catch (error) {
        console.error('ç”Ÿæˆæ¸¬é©—å¤±æ•—:', error);
        alert('ç”Ÿæˆæ¸¬é©—å¤±æ•—: ' + error.message);
        
        // å›åˆ°è¨­å®šé é¢
        document.getElementById('loading-card').classList.add('d-none');
        document.getElementById('quiz-setup').classList.remove('d-none');
    }
});

function renderQuiz(quiz) {
    const content = document.getElementById('quiz-content');
    content.innerHTML = '';
    
    quiz.questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'mb-4 p-3 border rounded';
        
        let questionHTML = `
            <h5 class="mb-3">ç¬¬ ${index + 1} é¡Œ</h5>
            <p class="fw-bold">${question.question}</p>
        `;
        
        if (quiz.quiz_type === 'multiple_choice') {
            questionHTML += '<div class="mt-3">';
            question.options.forEach((option, optIndex) => {
                const optionValue = option.split('.')[0].trim();
                questionHTML += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="q${question.id}" value="${optionValue}" id="q${question.id}_${optIndex}">
                        <label class="form-check-label" for="q${question.id}_${optIndex}">
                            ${option}
                        </label>
                    </div>
                `;
            });
            questionHTML += '</div>';
        } else if (quiz.quiz_type === 'true_false') {
            questionHTML += `
                <div class="mt-3">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="q${question.id}" value="true" id="q${question.id}_true">
                        <label class="form-check-label" for="q${question.id}_true">æ˜¯</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="q${question.id}" value="false" id="q${question.id}_false">
                        <label class="form-check-label" for="q${question.id}_false">å¦</label>
                    </div>
                </div>
            `;
        } else { // fill_blank
            questionHTML += `
                <div class="mt-3">
                    <input type="text" class="form-control" name="q${question.id}" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ">
                </div>
            `;
        }
        
        questionDiv.innerHTML = questionHTML;
        content.appendChild(questionDiv);
    });
    
    document.getElementById('submit-quiz-btn').classList.remove('d-none');
}

document.getElementById('submit-quiz-btn').addEventListener('click', function() {
    // æ”¶é›†ç­”æ¡ˆ
    currentQuiz.questions.forEach(question => {
        const inputs = document.querySelectorAll(`[name="q${question.id}"]`);
        
        if (currentQuiz.quiz_type === 'fill_blank') {
            userAnswers[question.id] = inputs[0].value.trim();
        } else {
            const selectedInput = Array.from(inputs).find(input => input.checked);
            userAnswers[question.id] = selectedInput ? selectedInput.value : null;
        }
    });
    
    // è¨ˆç®—çµæœ
    showResults();
});

function showResults() {
    let correctCount = 0;
    const totalQuestions = currentQuiz.questions.length;
    
    // éš±è—æ¸¬é©—ï¼Œé¡¯ç¤ºçµæœ
    document.getElementById('quiz-card').classList.add('d-none');
    document.getElementById('result-card').classList.remove('d-none');
    
    const resultContent = document.getElementById('result-content');
    resultContent.innerHTML = '';
    
    // è¨ˆç®—åˆ†æ•¸
    currentQuiz.questions.forEach((question, index) => {
        const userAnswer = userAnswers[question.id];
        let isCorrect = false;
        
        if (currentQuiz.quiz_type === 'true_false') {
            isCorrect = (userAnswer === 'true') === question.correct_answer;
        } else if (currentQuiz.quiz_type === 'fill_blank') {
            isCorrect = userAnswer && userAnswer.toLowerCase().includes(question.correct_answer.toLowerCase());
        } else {
            isCorrect = userAnswer === question.correct_answer;
        }
        
        if (isCorrect) correctCount++;
        
        // é¡¯ç¤ºæ¯é¡Œçµæœ
        const resultDiv = document.createElement('div');
        resultDiv.className = `mb-4 p-3 border rounded ${isCorrect ? 'border-success bg-light' : 'border-danger bg-light'}`;
        
        resultDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="mb-0">ç¬¬ ${index + 1} é¡Œ</h6>
                <span class="badge ${isCorrect ? 'bg-success' : 'bg-danger'}">
                    ${isCorrect ? 'âœ“ æ­£ç¢º' : 'âœ— éŒ¯èª¤'}
                </span>
            </div>
            <p class="fw-bold">${question.question}</p>
            <p><strong>æ‚¨çš„ç­”æ¡ˆï¼š</strong>${userAnswer || 'æœªä½œç­”'}</p>
            <p><strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong>${question.correct_answer}</p>
            <p><strong>è§£æï¼š</strong>${question.explanation}</p>
        `;
        
        resultContent.appendChild(resultDiv);
    });
    
    // é¡¯ç¤ºç¸½åˆ†
    const scorePercentage = Math.round((correctCount / totalQuestions) * 100);
    const scoreDiv = document.createElement('div');
    scoreDiv.className = 'alert alert-info text-center mb-4';
    scoreDiv.innerHTML = `
        <h4>ğŸ¯ æ¸¬é©—çµæœ</h4>
        <p class="mb-0">ç­”å° ${correctCount} / ${totalQuestions} é¡Œï¼Œå¾—åˆ†ï¼š${scorePercentage}%</p>
    `;
    resultContent.insertBefore(scoreDiv, resultContent.firstChild);
}

// é‡æ–°é–‹å§‹æŒ‰éˆ•
document.getElementById('restart-btn').addEventListener('click', function() {
    document.getElementById('quiz-card').classList.add('d-none');
    document.getElementById('result-card').classList.add('d-none');
    document.getElementById('quiz-setup').classList.remove('d-none');
    
    // é‡è¨­è¡¨å–®
    document.getElementById('quiz-form').reset();
    currentQuiz = null;
    userAnswers = {};
});

document.getElementById('new-quiz-btn').addEventListener('click', function() {
    document.getElementById('result-card').classList.add('d-none');
    document.getElementById('quiz-setup').classList.remove('d-none');
    
    // é‡è¨­è¡¨å–®
    document.getElementById('quiz-form').reset();
    currentQuiz = null;
    userAnswers = {};
});
</script>

<style>
.form-check-input:checked {
    background-color: #ffc107;
    border-color: #ffc107;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

#quiz-content .border {
    transition: all 0.3s ease;
}

#quiz-content .border:hover {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}
