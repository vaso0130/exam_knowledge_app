{% extends 'layout.html' %}
{% block title %}é¡Œç›®è©³æƒ… - {{ question.subject }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">ğŸ“ {{ question.title or ('é¡Œç›® Q' + question.id|string) }}</h2>
                    <small class="text-muted">ç§‘ç›®: {{ question.subject }} | ä¾†æº: {{ question.doc_title }}</small>
                </div>
                <div>
                    <a href="/questions" class="btn btn-outline-secondary btn-sm">â† è¿”å›é¡Œåº«</a>
                    {% if question.subject %}
                    <a href="/questions?subject={{ question.subject }}" class="btn btn-outline-primary btn-sm">æŸ¥çœ‹åŒç§‘ç›®</a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <!-- é¡Œç›®å…§å®¹ -->
                <div class="mb-4">
                    <h3 class="border-bottom pb-2 mb-3">ğŸ¯ é¡Œç›®å…§å®¹</h3>
                    <div class="question-content">
                        {{ question_html|safe }}
                    </div>
                </div>

                <!-- ç­”æ¡ˆå…§å®¹ -->
                {% if answer_html %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h3 class="mb-0">âœ… åƒè€ƒç­”æ¡ˆ</h3>
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary btn-sm" type="button" id="regenerate-answer">
                                <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆç­”æ¡ˆ
                            </button>
                            <a href="{{ url_for('edit_question', q_id=question.id) }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i> ç·¨è¼¯
                            </a>
                        </div>
                    </div>
                    
                    <!-- é‡æ–°ç”Ÿæˆé€²åº¦æç¤º -->
                    <div class="alert alert-info" id="answer-regenerating" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            <span>æ­£åœ¨é‡æ–°ç”Ÿæˆç­”æ¡ˆï¼Œè«‹ç¨å€™...</span>
                        </div>
                    </div>
                    
                    <div class="answer-content">
                        {{ answer_html|safe }}
                    </div>

                    <!-- ç­”æ¡ˆä¾†æº -->
                    {% if question.answer_sources and question.answer_sources != '[]' %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <h5 class="mb-2">ğŸ“š åƒè€ƒä¾†æº</h5>
                        <div class="sources-list">
                            {% set sources = question.answer_sources | fromjson %}
                            {% if sources %}
                            {% for source in sources %}
                            <div class="source-item mb-2">
                                <strong><a href="{{ source.url }}" target="_blank" class="text-decoration-none">{{
                                        source.title }}</a></strong>
                                <p class="text-muted small mb-0">{{ source.snippet }}</p>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted small mb-0">ç„¡çµæ§‹åŒ–ä¾†æºè³‡æ–™ã€‚</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- ç›¸é—œçŸ¥è­˜é» -->
                {% if question.knowledge_points %}
                <div class="mb-4">
                    <h3 class="border-bottom pb-2 mb-3">ğŸ§  ç›¸é—œçŸ¥è­˜é»</h3>
                    <div class="d-flex flex-wrap gap-2">
                        {% for kp in question.knowledge_points %}
                        <a href="{{ url_for('knowledge_detail', id=kp.id) }}"
                            class="badge bg-primary text-decoration-none">{{kp.name}}</a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- å°ˆå±¬å¿ƒæ™ºåœ– -->
                {% if mindmap_code %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h3 class="mb-0">ğŸŒ å¿ƒæ™ºåœ–</h3>
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary btn-sm" type="button" id="regenerate-mindmap">
                                <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆå¿ƒæ™ºåœ–
                            </button>
                            <button class="btn btn-info btn-sm" type="button" id="toggle-mermaid-code">
                                <i class="fas fa-code"></i> é¡¯ç¤ºåŸå§‹ç¢¼
                            </button>
                            <a href="{{ url_for('edit_question', q_id=question.id) }}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i> ç·¨è¼¯å¿ƒæ™ºåœ–
                            </a>
                        </div>
                    </div>
                    <div class="mindmap-container">
                        <div class="mermaid">
                            {{ mindmap_code|safe }}
                        </div>
                    </div>
                    <small class="text-muted">âœ¨ é€™æ˜¯é‡å°æ­¤é¡Œç›®ç”Ÿæˆçš„çŸ¥è­˜é—œè¯åœ–ï¼Œå¹«åŠ©æ‚¨æ€è€ƒç›¸é—œæ¦‚å¿µï¼</small>
                    
                    <!-- é‡æ–°ç”Ÿæˆé€²åº¦æç¤º -->
                        <div id="regenerate-progress" class="mt-2" style="display: none;">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨é‡æ–°ç”Ÿæˆå¿ƒæ™ºåœ–ï¼Œè«‹ç¨å€™...
                            </div>
                        </div>
                        
                        <!-- åŸå§‹ç¢¼é¡¯ç¤ºå€å¡Š -->
                        <div id="mermaid-code-block" class="mt-2" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <small class="text-muted">å¿ƒæ™ºåœ–åŸå§‹ç¢¼</small>
                                </div>
                                <div class="card-body">
                                    <pre class="mermaid-code"><code>{{ mindmap_code }}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            // é¡¯ç¤º/éš±è—åŸå§‹ç¢¼æŒ‰éˆ•
                            const toggleBtn = document.getElementById('toggle-mermaid-code');
                            const codeBlock = document.getElementById('mermaid-code-block');
                            let codeVisible = false;
                            
                            toggleBtn.addEventListener('click', function () {
                                codeVisible = !codeVisible;
                                codeBlock.style.display = codeVisible ? 'block' : 'none';
                                toggleBtn.innerHTML = codeVisible ? 
                                    '<i class="fas fa-code"></i> éš±è—åŸå§‹ç¢¼' : 
                                    '<i class="fas fa-code"></i> é¡¯ç¤ºåŸå§‹ç¢¼';
                            });
                            
                            // é‡æ–°ç”Ÿæˆå¿ƒæ™ºåœ–æŒ‰éˆ•
                            const regenerateBtn = document.getElementById('regenerate-mindmap');
                            const progressDiv = document.getElementById('regenerate-progress');
                            const mindmapContainer = document.querySelector('.mermaid');
                            const codeElement = document.querySelector('.mermaid-code code');
                            
                            regenerateBtn.addEventListener('click', function () {
                                // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºé€²åº¦
                                regenerateBtn.disabled = true;
                                regenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
                                progressDiv.style.display = 'block';
                                
                                // ç™¼é€é‡æ–°ç”Ÿæˆè«‹æ±‚
                                fetch('/regenerate_mindmap/{{ question.id }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // æ›´æ–°å¿ƒæ™ºåœ–é¡¯ç¤º
                                        mindmapContainer.innerHTML = data.mindmap_code;
                                        if (codeElement) {
                                            codeElement.textContent = data.mindmap_code;
                                        }
                                        
                                        // é‡æ–°åˆå§‹åŒ– Mermaid
                                        if (typeof mermaid !== 'undefined') {
                                            mermaid.init(undefined, mindmapContainer);
                                        }
                                        
                                        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                                        showAlert('success', 'å¿ƒæ™ºåœ–å·²é‡æ–°ç”Ÿæˆï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†...');
                                        
                                        // 2ç§’å¾Œé‡æ–°æ•´ç†é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„å¿ƒæ™ºåœ–
                                        setTimeout(() => {
                                            location.reload();
                                        }, 2000);
                                    } else {
                                        showAlert('danger', 'é‡æ–°ç”Ÿæˆå¤±æ•—: ' + data.error);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showAlert('danger', 'é‡æ–°ç”Ÿæˆå¤±æ•—: ' + error.message);
                                })
                                .finally(() => {
                                    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                                    regenerateBtn.disabled = false;
                                    regenerateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆå¿ƒæ™ºåœ–';
                                    progressDiv.style.display = 'none';
                                });
                            });
                            
                            // é‡æ–°ç”Ÿæˆç­”æ¡ˆæŒ‰éˆ•
                            const regenerateAnswerBtn = document.getElementById('regenerate-answer');
                            if (regenerateAnswerBtn) {
                                regenerateAnswerBtn.addEventListener('click', function() {
                                    // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºé€²åº¦
                                    regenerateAnswerBtn.disabled = true;
                                    regenerateAnswerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é‡æ–°ç”Ÿæˆä¸­...';
                                    const answerProgressDiv = document.getElementById('answer-regenerating');
                                    answerProgressDiv.style.display = 'block';

                                    // ç™¼é€é‡æ–°ç”Ÿæˆè«‹æ±‚
                                    fetch('/regenerate_answer/{{ question.id }}', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({})
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                                            showAlert('success', 'ç­”æ¡ˆå·²é‡æ–°ç”Ÿæˆï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†...');
                                            
                                            // 2ç§’å¾Œé‡æ–°æ•´ç†é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„ç­”æ¡ˆ
                                            setTimeout(() => {
                                                location.reload();
                                            }, 2000);
                                        } else {
                                            showAlert('danger', 'é‡æ–°ç”Ÿæˆå¤±æ•—: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error:', error);
                                        showAlert('danger', 'é‡æ–°ç”Ÿæˆå¤±æ•—: ' + error.message);
                                    })
                                    .finally(() => {
                                        // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                                        regenerateAnswerBtn.disabled = false;
                                        regenerateAnswerBtn.innerHTML = '<i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆç­”æ¡ˆ';
                                        answerProgressDiv.style.display = 'none';
                                    });
                                });
                            }
                            
                            // é¡¯ç¤ºé€šçŸ¥çš„è¼”åŠ©å‡½æ•¸
                            function showAlert(type, message) {
                                const alertDiv = document.createElement('div');
                                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-2`;
                                alertDiv.innerHTML = `
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;
                                progressDiv.parentNode.insertBefore(alertDiv, progressDiv.nextSibling);
                                
                                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
                                setTimeout(() => {
                                    if (alertDiv.parentNode) {
                                        alertDiv.parentNode.removeChild(alertDiv);
                                    }
                                }, 3000);
                            }
                        });
                    </script>
                    <!-- â–²â–²â–² é™¤éŒ¯å€å¡ŠçµæŸ â–²â–²â–² -->
                </div>
                {% else %}
                <!-- æ²’æœ‰å¿ƒæ™ºåœ–æ™‚çš„æç¤ºå’Œç”ŸæˆæŒ‰éˆ• -->
                <div class="mb-4">
                    <h3 class="border-bottom pb-2 mb-3">ğŸ§  å¿ƒæ™ºåœ–</h3>
                    <div class="text-center py-4">
                        <h5 class="text-muted">æ­¤é¡Œç›®å°šæœªç”Ÿæˆå¿ƒæ™ºåœ–</h5>
                        <p class="text-muted">å¿ƒæ™ºåœ–å¯ä»¥å¹«åŠ©æ‚¨è¦–è¦ºåŒ–ç›¸é—œçŸ¥è­˜é»ä¹‹é–“çš„é—œè¯</p>
                        
                        <button class="btn btn-success" id="generate-mindmap">
                            <i class="fas fa-magic"></i> ç”Ÿæˆå¿ƒæ™ºåœ–
                        </button>
                        
                        <!-- ç”Ÿæˆé€²åº¦æç¤º -->
                        <div id="generate-progress" class="mt-3" style="display: none;">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ç”Ÿæˆå¿ƒæ™ºåœ–ï¼Œè«‹ç¨å€™...
                            </div>
                        </div>
                        
                        <!-- å¿ƒæ™ºåœ–å®¹å™¨ï¼ˆç”Ÿæˆå¾Œé¡¯ç¤ºï¼‰ -->
                        <div id="new-mindmap-container" class="mt-4" style="display: none;">
                            <div class="mermaid" id="new-mindmap-content"></div>
                            <div class="mt-3">
                                <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                                    <i class="fas fa-refresh"></i> é‡æ–°æ•´ç†é é¢
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const generateBtn = document.getElementById('generate-mindmap');
                            const progressDiv = document.getElementById('generate-progress');
                            const containerDiv = document.getElementById('new-mindmap-container');
                            const contentDiv = document.getElementById('new-mindmap-content');
                            
                            generateBtn.addEventListener('click', function () {
                                // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºé€²åº¦
                                generateBtn.disabled = true;
                                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
                                progressDiv.style.display = 'block';
                                
                                // ç™¼é€ç”Ÿæˆè«‹æ±‚
                                fetch('/regenerate_mindmap/{{ question.id }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // é¡¯ç¤ºæ–°ç”Ÿæˆçš„å¿ƒæ™ºåœ–
                                        contentDiv.innerHTML = data.mindmap_code;
                                        containerDiv.style.display = 'block';
                                        generateBtn.style.display = 'none';
                                        
                                        // åˆå§‹åŒ– Mermaid
                                        if (typeof mermaid !== 'undefined') {
                                            mermaid.init(undefined, contentDiv);
                                        }
                                        
                                        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                                        showAlert('success', 'å¿ƒæ™ºåœ–å·²ç”Ÿæˆï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†ä»¥é¡¯ç¤ºå®Œæ•´åŠŸèƒ½ã€‚');
                                        
                                        // 3ç§’å¾Œé‡æ–°æ•´ç†é é¢
                                        setTimeout(() => {
                                            location.reload();
                                        }, 3000);
                                    } else {
                                        showAlert('danger', 'ç”Ÿæˆå¤±æ•—: ' + data.error);
                                        generateBtn.disabled = false;
                                        generateBtn.innerHTML = '<i class="fas fa-magic"></i> ç”Ÿæˆå¿ƒæ™ºåœ–';
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showAlert('danger', 'ç”Ÿæˆå¤±æ•—: ' + error.message);
                                    generateBtn.disabled = false;
                                    generateBtn.innerHTML = '<i class="fas fa-magic"></i> ç”Ÿæˆå¿ƒæ™ºåœ–';
                                })
                                .finally(() => {
                                    progressDiv.style.display = 'none';
                                });
                            });
                            
                            // é¡¯ç¤ºé€šçŸ¥çš„è¼”åŠ©å‡½æ•¸
                            function showAlert(type, message) {
                                const alertDiv = document.createElement('div');
                                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
                                alertDiv.innerHTML = `
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;
                                progressDiv.parentNode.insertBefore(alertDiv, progressDiv.nextSibling);
                                
                                // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
                                setTimeout(() => {
                                    if (alertDiv.parentNode) {
                                        alertDiv.parentNode.removeChild(alertDiv);
                                    }
                                }, 5000);
                            }
                        });
                    </script>
                </div>
                {% endif %}

                <!-- è§£é¡ŒæŠ€å·§å€å¡Š -->
                <div class="mb-4">
                    {% if question_summary and solving_tips %}
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h3 class="mb-0">ğŸ’¡ è§£é¡ŒæŠ€å·§</h3>
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary btn-sm regenerate-tips-btn">
                                <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆ
                            </button>
                        </div>
                    </div>
                    <div id="solving-tips-content">
                        <!-- é¡¯ç¤ºå·²å„²å­˜çš„è§£é¡ŒæŠ€å·§ -->
                        <div id="tips-result">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">é¡Œç›®æ‘˜è¦</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0">{{ question_summary }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">è§£é¡ŒæŠ€å·§</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-0">{{ solving_tips }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h3 class="mb-0">ğŸ’¡ è§£é¡ŒæŠ€å·§</h3>
                        {% if not question.solving_tips %}
                        <button class="btn btn-success btn-sm" id="generate-solving-tips">
                            <i class="fas fa-magic"></i> ç”Ÿæˆè§£é¡ŒæŠ€å·§
                        </button>
                        {% else %}
                        <button class="btn btn-primary btn-sm regenerate-tips-btn">
                            <i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆ
                        </button>
                        {% endif %}
                    </div>
                    <div id="solving-tips-content">
                        {% if question.solving_tips %}
                        <!-- é¡¯ç¤ºå·²å„²å­˜çš„è§£é¡ŒæŠ€å·§ -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">é¡Œç›®æ‘˜è¦</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-0">{{ question.question_summary or 'æš«ç„¡æ‘˜è¦' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">è§£é¡ŒæŠ€å·§</h6>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-0">{{ question.solving_tips }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- é¡¯ç¤ºæç¤ºè¨Šæ¯ -->
                        <div class="text-center">
                            <h5 class="text-muted">AI è§£é¡ŒæŠ€å·§èˆ‡æ‘˜è¦</h5>
                            <p class="text-muted">é»æ“ŠæŒ‰éˆ•è®“ AI åˆ†æé¡Œç›®ä¸¦æä¾›è§£é¡ŒæŠ€å·§èˆ‡é‡é»æ‘˜è¦</p>
                        </div>
                        {% endif %}
                        
                        <!-- ç”Ÿæˆé€²åº¦æç¤º -->
                        <div id="tips-progress" class="mt-3 d-none">
                            <div class="alert alert-info" role="alert">
                                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åˆ†æé¡Œç›®ä¸¦ç”Ÿæˆè§£é¡ŒæŠ€å·§ï¼Œè«‹ç¨å€™...
                            </div>
                        </div>
                        
                        <!-- è§£é¡ŒæŠ€å·§å…§å®¹å€åŸŸ -->
                        <div id="tips-result" class="mt-4 d-none">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">é¡Œç›®æ‘˜è¦</h6>
                                        </div>
                                        <div class="card-body">
                                            <p id="question-summary" class="mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">è§£é¡ŒæŠ€å·§</h6>
                                        </div>
                                        <div class="card-body">
                                            <p id="solving-tips" class="mb-0"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        {% endif %}
                    </div>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const generateTipsBtn = document.getElementById('generate-solving-tips');
                            const regenerateTipsBtns = document.querySelectorAll('.regenerate-tips-btn');
                            const tipsProgressDiv = document.getElementById('tips-progress');
                            const tipsResultDiv = document.getElementById('tips-result');
                            const questionSummaryEl = document.getElementById('question-summary');
                            const solvingTipsEl = document.getElementById('solving-tips');
                            
                            function generateSolvingTips() {
                                // ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºé€²åº¦
                                if (generateTipsBtn) {
                                    generateTipsBtn.disabled = true;
                                    generateTipsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
                                }
                                regenerateTipsBtns.forEach(btn => {
                                    btn.disabled = true;
                                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é‡æ–°ç”Ÿæˆä¸­...';
                                });
                                if (tipsProgressDiv) tipsProgressDiv.style.display = 'block';
                                
                                // ç™¼é€ç”Ÿæˆè«‹æ±‚
                                fetch('/generate_solving_tips/{{ question.id }}', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    }
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        // å¦‚æœæœ‰å‹•æ…‹å…ƒç´ ï¼Œæ›´æ–°å…¶å…§å®¹
                                        if (questionSummaryEl) questionSummaryEl.textContent = data.summary;
                                        if (solvingTipsEl) solvingTipsEl.textContent = data.solving_tips;
                                        if (tipsResultDiv) tipsResultDiv.style.display = 'block';
                                        if (generateTipsBtn) generateTipsBtn.style.display = 'none';
                                        
                                        // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯ä¸¦é‡æ–°æ•´ç†é é¢ä»¥é¡¯ç¤ºå„²å­˜çš„è³‡æ–™
                                        showTipsAlert('success', 'è§£é¡ŒæŠ€å·§å·²æˆåŠŸç”Ÿæˆä¸¦å„²å­˜ï¼é é¢å°‡è‡ªå‹•é‡æ–°æ•´ç†...');
                                        setTimeout(() => {
                                            location.reload();
                                        }, 2000);
                                    } else {
                                        showTipsAlert('danger', 'ç”Ÿæˆå¤±æ•—: ' + data.error);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    showTipsAlert('danger', 'ç”Ÿæˆå¤±æ•—: ' + error.message);
                                })
                                .finally(() => {
                                    // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
                                    if (generateTipsBtn) {
                                        generateTipsBtn.disabled = false;
                                        generateTipsBtn.innerHTML = '<i class="fas fa-magic"></i> ç”Ÿæˆè§£é¡ŒæŠ€å·§';
                                    }
                                    regenerateTipsBtns.forEach(btn => {
                                        btn.disabled = false;
                                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> é‡æ–°ç”Ÿæˆ';
                                    });
                                    if (tipsProgressDiv) tipsProgressDiv.style.display = 'none';
                                });
                            }
                            
                            if (generateTipsBtn) {
                                generateTipsBtn.addEventListener('click', generateSolvingTips);
                            }
                            regenerateTipsBtns.forEach(btn => {
                                btn.addEventListener('click', generateSolvingTips);
                            });
                            
                            // é¡¯ç¤ºé€šçŸ¥çš„è¼”åŠ©å‡½æ•¸
                            function showTipsAlert(type, message) {
                                const alertDiv = document.createElement('div');
                                alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
                                alertDiv.innerHTML = `
                                    ${message}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                `;
                                tipsProgressDiv.parentNode.insertBefore(alertDiv, tipsProgressDiv.nextSibling);
                                
                                // 5ç§’å¾Œè‡ªå‹•ç§»é™¤
                                setTimeout(() => {
                                    if (alertDiv.parentNode) {
                                        alertDiv.parentNode.removeChild(alertDiv);
                                    }
                                }, 5000);
                            }
                        });
                    </script>
                </div>

                <!-- ä¾†æºè³‡è¨Š -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h5 class="mb-2">ğŸ“‹ é¡Œç›®è³‡è¨Š</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>ç§‘ç›®:</strong> {{ question.subject or 'æœªåˆ†é¡' }}<br>
                            <strong>é›£åº¦:</strong> {{ question.difficulty or 'æœªçŸ¥' }}
                            {% if question.guidance_level %}
                            ({{ question.guidance_level }}å¼•å°)
                            {% endif %}<br>
                            <strong>ä¾†æºæ–‡ä»¶:</strong>
                            {% if question.document_id %}
                            <a href="{{ url_for('document_detail', doc_id=question.document_id) }}"
                                class="text-decoration-none">
                                ğŸ“„ {{ question.doc_title or 'æœªçŸ¥' }}
                            </a>
                            <br>
                            <a href="{{ url_for('original_document', doc_id=question.document_id) }}"
                                class="btn btn-sm btn-outline-info mt-1">
                                ğŸ“œ æª¢è¦–åŸå§‹æ–‡ä»¶
                            </a>
                            {% else %}
                            æœªçŸ¥
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>å»ºç«‹æ™‚é–“:</strong> {{ question.created_at or 'æœªçŸ¥' }}<br>
                            <strong>ID:</strong> {{ question.id }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* è‡ªå®šç¾©æ¨£å¼ï¼Œæ”¹å–„å…§å®¹é¡¯ç¤º */
    .question-content,
    .answer-content {
        line-height: 1.6;
        font-size: 1.1rem;
    }

    .question-content h1,
    .question-content h2,
    .question-content h3,
    .answer-content h1,
    .answer-content h2,
    .answer-content h3 {
        color: #495057;
        margin-top: 1.5rem;
        margin-bottom: 0.8rem;
    }

    .question-content p,
    .answer-content p {
        margin-bottom: 1rem;
    }

    .question-content ul,
    .question-content ol,
    .answer-content ul,
    .answer-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }

    .question-content li,
    .answer-content li {
        margin-bottom: 0.3rem;
    }

    .question-content blockquote,
    .answer-content blockquote {
        border-left: 4px solid #007bff;
        margin: 1rem 0;
        padding: 0.5rem 1rem;
        background-color: #f8f9fa;
    }

    .question-content table,
    .answer-content table {
        width: 100%;
        margin: 1rem 0;
        border-collapse: collapse;
    }

    .question-content th,
    .question-content td,
    .answer-content th,
    .answer-content td {
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        text-align: left;
    }

    .question-content th,
    .answer-content th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    /* ä¸­æ–‡ç·¨è™Ÿå…§å®¹æ ¼å¼åŒ– - å¢å¼·å¯è®€æ€§ */
    .answer-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
    }

    /* ç‚ºä¸­æ–‡ç·¨è™Ÿæ®µè½æä¾›æ›´å¥½çš„é–“è· */
    .answer-content p {
        line-height: 1.8;
        margin-bottom: 1rem;
    }

    /* ç¨‹å¼ç¢¼å€å¡Šçš„ç‰¹æ®Šè™•ç† */
    .answer-content pre {
        margin: 1.5rem 0;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        font-family: "Courier New", Consolas, monospace;
        overflow-x: auto;
    }

    /* åŠ å¼·æ¨™é¡Œå±¤ç´šçš„è¦–è¦ºå€åˆ† */
    .answer-content p:first-line {
        font-weight: 500;
    }
</style>
{% endblock %}