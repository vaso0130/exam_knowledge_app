{% extends 'layout.html' %}
{% block title %}åŸå§‹æ–‡ä»¶ - {{ document.title }}{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-11 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">ğŸ“œ åŸå§‹æ–‡ä»¶å…§å®¹</h2>
                    <small class="text-muted">{{ document.title }} | ç§‘ç›®: {{ document.subject }}</small>
                </div>
                <div>
                    <a href="{{ url_for('question_detail', q_id=request.args.get('from_question')) if request.args.get('from_question') else 'javascript:history.back()' }}" 
                       class="btn btn-outline-secondary btn-sm">â† è¿”å›</a>
                    <a href="{{ url_for('document_detail', doc_id=document.id) }}" class="btn btn-outline-primary btn-sm">æ–‡ä»¶è©³æƒ…</a>
                </div>
            </div>
            <div class="card-body">
                <!-- æ–‡ä»¶è³‡è¨Š -->
                <div class="alert alert-info">
                    <h5 class="alert-heading">ğŸ“‹ æ–‡ä»¶è³‡è¨Š</h5>
                    <hr>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>æ¨™é¡Œ:</strong> {{ document.title }}<br>
                            <strong>ç§‘ç›®:</strong> {{ document.subject or 'æœªåˆ†é¡' }}
                        </div>
                        <div class="col-md-4">
                            <strong>é¡å‹:</strong> {{ document.type or 'è³‡è¨Š' }}<br>
                            <strong>å»ºç«‹æ™‚é–“:</strong> {{ document.created_at or 'æœªçŸ¥' }}
                        </div>
                        <div class="col-md-4">
                            {% if document.source and (document.source.startswith('http://') or document.source.startswith('https://')) %}
                            <strong>ä¾†æºç¶²å€:</strong> <a href="{{ document.source }}" target="_blank" class="text-break">{{ document.source }}</a>
                            {% elif document.file_path %}
                            <strong>ä¾†æºæª”æ¡ˆ:</strong> {{ document.file_path.split('/')[-1] or document.file_path.split('\\')[-1] }}
                            {% else %}
                            <strong>ä¾†æº:</strong> ç›´æ¥è¼¸å…¥
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- åŸå§‹å…§å®¹ -->
                <div class="mb-4">
                    <h3 class="border-bottom pb-2 mb-3">ğŸ“„ åŸå§‹å…§å®¹</h3>
                    <div class="original-content border rounded p-3" style="background-color: #f8f9fa;">
                        {% if original_html %}
                            {{ original_html|safe }}
                        {% elif document.original_content %}
                            <pre class="mb-0 text-wrap">{{ document.original_content }}</pre>
                        {% elif document.content %}
                            <pre class="mb-0 text-wrap">{{ document.content }}</pre>
                        {% else %}
                            <p class="text-muted">ç„¡åŸå§‹å…§å®¹å¯é¡¯ç¤º</p>
                        {% endif %}
                    </div>
                </div>

                <!-- è™•ç†èªªæ˜ -->
                <div class="mt-4 p-3 bg-light rounded">
                    <h5 class="mb-2">â„¹ï¸ è™•ç†èªªæ˜</h5>
                    <p class="mb-1">â€¢ <strong>åŸå§‹å…§å®¹</strong>ï¼šä¸Šæ–¹é¡¯ç¤ºçš„æ˜¯æ–‡ä»¶æœ€åˆä¸Šå‚³æ™‚çš„åŸå§‹ç‹€æ…‹</p>
                    <p class="mb-1">â€¢ <strong>AI è™•ç†</strong>ï¼šç³»çµ±å·²åŸºæ–¼æ­¤å…§å®¹ç”Ÿæˆé¡Œç›®ã€ç­”æ¡ˆå’ŒçŸ¥è­˜é»</p>
                    <p class="mb-0">â€¢ <strong>ç”¨é€”</strong>ï¼šæ‚¨å¯ä»¥å°ç…§åŸå§‹å…§å®¹ä¾†é©—è­‰ AI ç”Ÿæˆçš„é¡Œç›®æ˜¯å¦æº–ç¢º</p>
                </div>

                <!-- ç›¸é—œé¡Œç›®å¿«é€Ÿé€£çµ -->
                <div class="mt-4">
                    <h5 class="mb-3">ğŸ”— åŸºæ–¼æ­¤æ–‡ä»¶ç”Ÿæˆçš„é¡Œç›®</h5>
                    <div id="related-questions">
                        <p class="text-muted">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// è¼‰å…¥ç›¸é—œé¡Œç›®
fetch(`/api/questions?document_id={{ document.id }}`)
    .then(response => response.json())
    .then(data => {
        const questionsDiv = document.getElementById('related-questions');
        if (data.questions && data.questions.length > 0) {
            questionsDiv.innerHTML = data.questions.map((q, index) => `
                <div class="d-inline-block me-2 mb-2">
                    <a href="/question/${q.id}" class="btn btn-outline-primary btn-sm">
                        Q${index + 1}: ${q.title || 'Q' + q.id}
                    </a>
                </div>
            `).join('');
        } else {
            questionsDiv.innerHTML = '<p class="text-muted">æ­¤æ–‡ä»¶å°šç„¡ç›¸é—œé¡Œç›®</p>';
        }
    })
    .catch(err => {
        document.getElementById('related-questions').innerHTML = '<p class="text-danger">è¼‰å…¥é¡Œç›®å¤±æ•—</p>';
    });
</script>

<style>
.original-content {
    max-height: 70vh;
    overflow-y: auto;
    line-height: 1.6;
}

.original-content pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 14px;
}

.original-content h1, .original-content h2, .original-content h3 {
    color: #007bff;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.original-content p {
    margin-bottom: 1rem;
}

.original-content code {
    background-color: #e9ecef;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}
</style>
{% endblock %}
